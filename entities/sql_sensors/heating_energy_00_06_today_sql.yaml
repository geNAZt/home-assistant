name: heating_energy_00_06_today_sql
unit_of_measurement: "kWh"
query: >
  WITH win AS (
    -- Start/Ende des heutigen lokalen 00:00–06:00 in UTC-Sekunden
    SELECT
      CAST(strftime('%s','now','localtime','start of day') AS INTEGER) AS t0_utc,
      CAST(strftime('%s','now','localtime','start of day','+6 hours') AS INTEGER) AS t1_utc
  ),
  per AS (
    SELECT s.metadata_id AS mid,
           (MAX(s.sum) - MIN(s.sum)) AS delta
    FROM statistics_short_term s
    JOIN statistics_meta m ON m.id = s.metadata_id
    JOIN win w
    WHERE m.statistic_id IN (
      'sensor.heating_usage_bad',
      'sensor.heating_usage_buero_fabian',
      'sensor.heating_usage_buero_merja',
      'sensor.heating_usage_flur',
      'sensor.heating_usage_kueche',
      'sensor.heating_usage_schlafzimmer',
      'sensor.heating_usage_speisekammer',
      'sensor.heating_usage_wohnzimmer'
    )
      AND s.start_ts >= w.t0_utc AND s.start_ts < w.t1_utc
    GROUP BY s.metadata_id
  )
  SELECT ROUND(
    COALESCE(SUM(
      CASE
        WHEN LOWER(m.unit_of_measurement) IN ('wh','w·h','w*h') THEN per.delta / 1000.0
        ELSE per.delta
      END
    ),0), 3) AS value
  FROM per
  JOIN statistics_meta m ON m.id = per.mid;
column: "value"