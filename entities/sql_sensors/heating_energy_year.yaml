name: Heizenergie letztes Jahr
query: >
  SELECT
    ROUND(SUM(
      CASE uom
        WHEN 'Wh'  THEN (max_v - min_v) / 1000.0
        WHEN 'kWh' THEN (max_v - min_v)
        ELSE (max_v - min_v) / 1000.0
      END
    ), 1) AS value
  FROM (
    SELECT
      sm.statistic_id,

      /* unit_of_measurement is typically in state_attributes.shared_attrs */
      sm.unit_of_measurement AS uom,

      MAX(CAST(s.state AS DECIMAL(20,6))) AS max_v,
      MIN(CAST(s.state AS DECIMAL(20,6))) AS min_v
    FROM statistics s
    JOIN statistics_meta sm
      ON s.metadata_id = sm.id
    WHERE
      (
        sm.statistic_id LIKE 'sensor.heating_usage_%'
        OR sm.statistic_id IN (
          'sensor.water_heating_pump_usage',
          'sensor.water_cycling_pump_usage',
          'sensor.shellyplus2pm_485519a264d8_switch_1_energy'
        )
      )
      AND sm.statistic_id NOT LIKE '%total%'
      AND sm.statistic_id NOT LIKE '%gesamt%'
      AND s.start_ts >= UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 YEAR))

      /* skip non-numeric states */
      AND s.state REGEXP '^-?[0-9]+(\\.[0-9]+)?$'
    GROUP BY
      sm.statistic_id
  ) t;
column: "value"
unit_of_measurement: "kWh"