update_tibber_price_thresholds:
  alias: "Update Tibber Preis-Schwellen"
  mode: single
  sequence:
    # 1) Zeitfenster: jetzt â†’ jetzt+24h (als ISO, ohne timedelta)
    - variables:
        now_ts: "{{ as_timestamp(now()) }}"
        start_str: "{{ (now_ts) | timestamp_custom('%Y-%m-%d %H:00:00', true) }}"
        end_str:   "{{ (now_ts + 86400) | timestamp_custom('%Y-%m-%d %H:00:00', true) }}"
    - service: tibber.get_prices
      data:
        start: "{{ start_str }}"
        end:   "{{ end_str }}"
      response_variable: tib
    # 2) Preise extrahieren & Metriken berechnen (ohne verschachtelte Objekte)
    - variables:
        price_dict: "{{ tib.prices | default({}) }}"
  
        # Max-Preis (direkt per Doppelschleife)
        pmax: >-
          {% set m = 0.0 %}
          {% for k, arr in price_dict.items() %}
            {% if arr is iterable %}
              {% for it in arr %}
                {% set pr = it.price if it.price is defined else it['price'] %}
                {% if pr|float(0) > m %}{% set m = pr|float(0) %}{% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {{ m }}
  
        # Perzentil-Wert (z.B. P10): baue Liste im selben Block, sortiere, nimm Index floor(n*pcut)
        p_pct_value: >-
          {% set prices = [] %}
          {% for k, arr in price_dict.items() %}
            {% if arr is iterable %}
              {% for it in arr %}
                {% set prices = prices + [ (it.price if it.price is defined else it['price'])|float(0) ] %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% set n = prices|length %}
          {% if n > 0 %}
            {% set pcut = (states('input_number.price_percentile_cutoff')|float(10) / 100.0) %}
            {% set idx = (n * pcut) | int(0) %}
            {% set idx = 0 if idx < 0 else (n-1 if idx >= n else idx) %}
            {% set sorted = prices | sort %}
            {{ sorted[idx] }}
          {% else %}
            0
          {% endif %}
  
        # %-vom-Max
        p_of_max: >-
          {% set alpha = states('input_number.price_percent_of_max')|float(50) / 100.0 %}
          {% set pm = (pmax|float(0)) %}
          {{ (pm * alpha) if pm > 0 else 0 }}
  
        # Effektiver (strengster) Cheap-Schwellenwert
        cheap_thr: "{{ [p_pct_value|float(0), p_of_max|float(0)] | min }}"
    # 3) Ergebnisse in Helpers schreiben
    - service: input_number.set_value
      target: { entity_id: input_number.price_max_today }
      data:   { value: "{{ pmax | float(0) }}" }
    - service: input_number.set_value
      target: { entity_id: input_number.price_p10_today }
      data:   { value: "{{ p_pct_value | float(0) }}" }
    - service: input_number.set_value
      target: { entity_id: input_number.price_threshold_value }
      data:   { value: "{{ cheap_thr | float(0) }}" }
