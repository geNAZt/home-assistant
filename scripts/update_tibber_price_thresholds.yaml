update_tibber_price_thresholds:
  alias: "Update Tibber Preis-Schwellen"
  mode: single
  sequence:
    # 1) Zeitfenster: jetzt â†’ jetzt+24h (als ISO, ohne timedelta)
    - variables:
        now_ts: "{{ as_timestamp(now()) }}"
        start_str: "{{ (now_ts) | timestamp_custom('%Y-%m-%d %H:00:00', true) }}"
        end_str:   "{{ (now_ts + 86400) | timestamp_custom('%Y-%m-%d %H:00:00', true) }}"
    - service: tibber.get_prices
      data:
        start: "{{ start_str }}"
        end:   "{{ end_str }}"
      response_variable: tib
    # 2) Preise extrahieren & Metriken berechnen (HA-kompatibel mit namespace)
    - variables:
        price_dict: "{{ tib.prices | default({}) }}"

        # Max-Preis
        pmax: >-
          {% set ns = namespace(m=0.0) %}
          {% for k in price_dict %}
            {% set arr = price_dict[k] %}
            {% if arr is iterable %}
              {% for it in arr %}
                {% set pr = (it.price if it.price is defined else (it['price'] if 'price' in it else 0)) | float(0) %}
                {% if pr > ns.m %}{% set ns.m = pr %}{% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {{ ns.m }}

        # Perzentil (z.B. P10)
        p_pct_value: >-
          {% set ns = namespace(prices=[]) %}
          {% for k in price_dict %}
            {% set arr = price_dict[k] %}
            {% if arr is iterable %}
              {% for it in arr %}
                {% set ns.prices = ns.prices + [ (it.price if it.price is defined else (it['price'] if 'price' in it else 0)) | float(0) ] %}
              {% endfor %}
            {% endif %}
          {% endfor %}
          {% set n = ns.prices|length %}
          {% if n > 0 %}
            {% set sorted = ns.prices | sort %}
            {% set pcut = (states('input_number.price_percentile_cutoff')|float(10) / 100.0) %}
            {% set idx = (n * pcut) | int(0) %}
            {% if idx < 0 %}{% set idx = 0 %}{% endif %}
            {% if idx > n-1 %}{% set idx = n-1 %}{% endif %}
            {{ sorted[idx] }}
          {% else %}
            0
          {% endif %}

        # %-vom-Max
        p_of_max: >-
          {% set alpha = states('input_number.price_percent_of_max')|float(50) / 100.0 %}
          {% set pm = pmax|float(0) %}
          {{ (pm * alpha) if pm > 0 else 0 }}

        # Effektiver (strengster) Cheap-Threshold
        cheap_thr: "{{ [p_pct_value|float(0), p_of_max|float(0)] | min }}"

    # 3) Ergebnisse in Helpers schreiben
    - service: input_number.set_value
      target: { entity_id: input_number.price_max_today }
      data:   { value: "{{ pmax | float(0) }}" }
    - service: input_number.set_value
      target: { entity_id: input_number.price_p10_today }
      data:   { value: "{{ p_pct_value | float(0) }}" }
    - service: input_number.set_value
      target: { entity_id: input_number.price_threshold_value }
      data:   { value: "{{ cheap_thr | float(0) }}" }
