- id: fetch_weather_daily_and_compute_means
  alias: "Weather: daily forecast → 24h Außen-Ø & ΔT"
  mode: single
  trigger:
    - platform: time_pattern
      hours: "/3"
      minutes: 7

  variables:
    climates: >
      {{ [
        'climate.raum_bad','climate.raum_kueche','climate.raum_schlafzimmer',
        'climate.raum_flur','climate.raum_speisekammer','climate.raum_wohnzimmer',
        'climate.raum_buero_merja','climate.raum_buero_fabian'
      ] }}

    # Innenziel-Mittel (jetzige Setpoints)
    inside_target_mean_c: >-
      {% set vals = [] %}
      {% for ce in climates %}
        {% set t = state_attr(ce,'temperature') %}
        {% if t is number %}{% set vals = vals + [ t|float ] %}{% endif %}
      {% endfor %}
      {{ ((vals|sum / (vals|length)) if (vals|length>0) else 22) | round(2) }}

  action:
    - action: weather.get_forecasts
      target:
        entity_id: weather.home
      data:
        type: daily
      response_variable: fc

    - variables:
        # Liste der (High/Low)-Mittel für die nächsten 24h
        outside_vals: >-
          {% set now_ts = as_timestamp(now()) %}
          {% set ahead  = now_ts + 24*3600 %}
          {% set arr = fc['weather.home']['forecast'] if 'weather.home' in fc else [] %}
          {% set vals = [] %}
          {% for e in arr %}
            {% set ts = as_timestamp(e.datetime if e.datetime is defined else e['datetime']) %}
            {% if ts is number and now_ts <= ts <= ahead %}
              {% set th = e.temperature if e.temperature is defined else e['temperature'] %}
              {% set tl = e.templow    if e.templow    is defined else e.get('templow') %}
              {% if (th is number) and (tl is number) %}
                {% set vals = vals + [ (th|float + tl|float)/2 ] %}
              {% elif th is number %}
                {% set vals = vals + [ th|float ] %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ vals | tojson }}

        outside_temp_forecast_24h_c: >-
          {% set vals = outside_vals | from_json(default=[]) %}
          {% if vals|length > 0 %}
            {{ (vals|sum / (vals|length)) | round(2) }}
          {% else %}
            {{ states('sensor.outside_temp_mean_24h_sql')|float(8) }}
          {% endif %}

        delta_t_forecast_k: >-
          {% set outside_avg = (outside_vals | from_json(default=[])) %}
          {% set outside_avg = ((outside_avg|sum / (outside_avg|length)) if (outside_avg|length>0) else states('sensor.outside_temp_mean_24h_sql')|float(8)) %}
          {% set inside_avg  = states('sensor.inside_target_mean_c')|float(22) %}
          {{ (inside_avg - outside_avg) | round(2) }}

    - service: input_number.set_value
      data:
        entity_id: input_number.outside_temp_forecast_24h_c
        value: "{{ outside_temp_forecast_24h_c }}"

    - service: input_number.set_value
      data:
        entity_id: input_number.delta_t_forecast_k
        value: "{{ delta_t_forecast_k }}"

    - service: logbook.log
      data:
        name: "Forecast→Set"
        message: >-
          outside_vals={{ outside_vals }},
          outside_avg={{ outside_temp_forecast_24h_c }},
          inside_target_avg={{ inside_target_mean_c }},
          dT={{ delta_t_forecast_k }}
        entity_id: weather.home
- id: heating_plan_every_5min
  alias: "Heizung: Planung alle 5 Minuten (PV/Preheat/Phasen)"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/5"
  variables:
    # ------------------ Räume zentral pflegen ------------------
    # Räume als JSON-String halten (sicher) …
    rooms_json: '["bad","kueche","schlafzimmer","flur","speisekammer","wohnzimmer","buero_merja","buero_fabian"]'

    # Climate-Entity je Raum
    cl_map: >-
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set m = m | combine({ r: 'climate.raum_' ~ r }) %}
      {% endfor %}
      {{ (m | tojson) | string }}

    # Solltemperatur (Basis) je Raum
    t_set_base: >-
      {% set cl = cl_map | from_json(default={}) %}
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set ce = cl.get(r) %}
        {% set t = state_attr(ce,'temperature') if ce else None %}
        {% set m = m | combine({ r: (t|float(22)) }) %}
      {% endfor %}
      {{ (m | tojson) | string }}

    # Isttemperatur je Raum
    t_now: >-
      {% set cl = cl_map | from_json(default={}) %}
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set ce = cl.get(r) %}
        {% set t = state_attr(ce,'current_temperature') if ce else None %}
        {% set m = m | combine({ r: (t|float(22)) }) %}
      {% endfor %}
      {{ (m | tojson) | string }}

    # ------------------ PV-Excess / Preheat-Offsets ------------------
    pv_forecast_w: "{{ states('sensor.solcast_pv_forecast_leistung_in_30_minuten')|float(0) }}"
    pv_thr_w:      "{{ states('input_number.pv_excess_threshold_w')|float(0) }}"
    has_pv_excess: "{{ pv_forecast_w > pv_thr_w }}"

    # Vorheizfenster lokal 00:00–06:00
    is_preheat_window: >-
      {% set nowts = as_timestamp(now()) %}
      {% set t0 = as_timestamp(now().replace(hour=0, minute=0, second=0, microsecond=0)) %}
      {% set t1 = as_timestamp(now().replace(hour=6, minute=0, second=0, microsecond=0)) %}
      {{ t0 <= nowts < t1 }}

    # Kennwerte
    C_eff: "{{ states('sensor.C_kWh_per_K_rolling')|float(10) }}"
    H_eff: "{{ states('sensor.H_kW_per_K_rolling_sql')|float(6.25) }}"
    dT_forecast: "{{ states('input_number.delta_t_forecast_k')|float(0) }}"

    # PV-Offset (K): 0.5 K wenn PV-Excess  (—> vor offset_k definieren!)
    pv_offset_k: "{{ 0.5 if has_pv_excess else 0 }}"

    # Preheat-Offset (K) aus H_eff & ΔT, sauber auf 0.2..0.6 clampen
    preheat_offset_k: >-
      {% set C = states('sensor.C_kWh_per_K_rolling')|float(0) %}
      {% set H = states('sensor.H_kW_per_K_rolling_sql')|float(6.25) %}
      {% set need_kwh = H * dT_forecast %}
      {% set off_raw = (need_kwh / C) if C > 0 else 0 %}
      {% if not is_preheat_window %}0
      {% else %}
        {% set clamped1 = 0.2 if off_raw < 0.2 else off_raw %}
        {% set clamped  = 0.6 if clamped1 > 0.6 else clamped1 %}
        {{ clamped }}
      {% endif %}

    # Gesamtoffset (K) inkl. PV-Offset, clamp 0..0.6 K
    offset_k: >-
      {%- set total = (preheat_offset_k|float(0)) + (pv_offset_k|float(0)) -%}
      {%- if total < 0 -%}
        0
      {%- elif total > 0.6 -%}
        0.6
      {%- else -%}
        {{ total }}
      {%- endif -%}

    # Effektives Soll je Raum (Basis + Offset)
    t_set_eff: >-
      {% set base = t_set_base | from_json(default={}) %}
      {% set off = offset_k | float(0) %}
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set m = m | combine({ r: ((base.get(r,22)) + off) }) %}
      {% endfor %}
      {{ m | tojson }}

    # ------------------ Phasen & Ströme ------------------
    phase_map: >-
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set l1 = 'sensor.current_l1_' ~ r ~ '_current' %}
        {% set l2 = 'sensor.current_l2_' ~ r ~ '_current' %}
        {% set l3 = 'sensor.current_l3_' ~ r ~ '_current' %}
        {% set p = 0 %}
        {% if states(l1) not in ['unknown','unavailable','None',''] %}{% set p = 1 %}
        {% elif states(l2) not in ['unknown','unavailable','None',''] %}{% set p = 2 %}
        {% elif states(l3) not in ['unknown','unavailable','None',''] %}{% set p = 3 %}
        {% endif %}
        {% set m = m | combine({ r: p }) %}
      {% endfor %}
      {{ m | tojson }}

    amps_map: >-
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set l1 = 'sensor.current_l1_' ~ r ~ '_current' %}
        {% set l2 = 'sensor.current_l2_' ~ r ~ '_current' %}
        {% set l3 = 'sensor.current_l3_' ~ r ~ '_current' %}
        {% set live_ma = states(l1)|float(0) if states(l1) not in ['unknown','unavailable','None',''] else
                         (states(l2)|float(0) if states(l2) not in ['unknown','unavailable','None',''] else
                          (states(l3)|float(0) if states(l3) not in ['unknown','unavailable','None',''] else 0)) %}
        {% set live_a = live_ma/1000 if live_ma>0 else 0 %}
        {% set sql_a  = states('sensor.heater_' ~ r ~ '_max_current_a')|float(0) %}
        {% set rated  = states('input_number.heater_' ~ r ~ '_rated_a')|float(0) %}
        {% set a = live_a if live_a>0 else (sql_a if sql_a>0 else rated) %}
        {% set m = m | combine({ r: a }) %}
      {% endfor %}
      {{ m | tojson }}

    # Temperaturfehler (Priorisierung)
    terr_map: >-
      {% set tnow = t_now     | from_json(default={}) %}
      {% set teff = t_set_eff | from_json(default={}) %}
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set m = m | combine({ r: ((teff.get(r,22)) - (tnow.get(r,22))) }) %}
      {% endfor %}
      {{ m | tojson }}

    # Bedarf: heizen nur wenn Ist < Soll_eff - 0.05 K
    need_map: >-
      {% set tnow = t_now     | from_json(default={}) %}
      {% set teff = t_set_eff | from_json(default={}) %}
      {% set H = 0.05 %}
      {% set m = {} %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% set need = (tnow.get(r,22) < (teff.get(r,22) - H)) %}
        {% set m = m | combine({ r: need }) %}
      {% endfor %}
      {{ m | tojson }}

    # Kandidatenliste (Räume mit Bedarf)
    cand_list: >-
      {% set need = need_map | from_json(default={}) %}
      {% set out = [] %}
      {% for r in rooms_json | from_json(default=[]) %}
        {% if need.get(r,false) %}{% set out = out + [r] %}{% endif %}
      {% endfor %}
      {{ out | tojson }}

    # Greedy-Auswahl je Phase (≤16A), Sortierung nach größtem Fehler
    sel_p1: >-
      {% set PH=16.0 %}
      {% set ph = phase_map|from_json(default={}) %}
      {% set er = terr_map |from_json(default={}) %}
      {% set ar = amps_map |from_json(default={}) %}
      {% set C  = cand_list|from_json(default=[]) %}
      {% set D = [] %}
      {% for r in C %}{% if ph.get(r,0)==1 %}{% set D = D + [ {'r':r,'e':er.get(r,0)|float(0),'a':ar.get(r,0)|float(0)} ] %}{% endif %}{% endfor %}
      {% set D = D|sort(attribute='e', reverse=True) %}
      {% set sum = 0.0 %}{% set pick = [] %}
      {% for d in D %}{% if sum + d.a <= PH %}{% set sum = sum + d.a %}{% set pick = pick + [d.r] %}{% endif %}{% endfor %}
      {{ pick | tojson }}

    sel_p2: >-
      {% set PH=16.0 %}
      {% set ph = phase_map|from_json(default={}) %}
      {% set er = terr_map |from_json(default={}) %}
      {% set ar = amps_map |from_json(default={}) %}
      {% set C  = cand_list|from_json(default=[]) %}
      {% set D = [] %}
      {% for r in C %}{% if ph.get(r,0)==2 %}{% set D = D + [ {'r':r,'e':er.get(r,0)|float(0),'a':ar.get(r,0)|float(0)} ] %}{% endif %}{% endfor %}
      {% set D = D|sort(attribute='e', reverse=True) %}
      {% set sum = 0.0 %}{% set pick = [] %}
      {% for d in D %}{% if sum + d.a <= PH %}{% set sum = sum + d.a %}{% set pick = pick + [d.r] %}{% endif %}{% endfor %}
      {{ pick | tojson }}

    sel_p3: >-
      {% set PH=16.0 %}
      {% set ph = phase_map|from_json(default={}) %}
      {% set er = terr_map |from_json(default={}) %}
      {% set ar = amps_map |from_json(default={}) %}
      {% set C  = cand_list|from_json(default=[]) %}
      {% set D = [] %}
      {% for r in C %}{% if ph.get(r,0)==3 %}{% set D = D + [ {'r':r,'e':er.get(r,0)|float(0),'a':ar.get(r,0)|float(0)} ] %}{% endif %}{% endfor %}
      {% set D = D|sort(attribute='e', reverse=True) %}
      {% set sum = 0.0 %}{% set pick = [] %}
      {% for d in D %}{% if sum + d.a <= PH %}{% set sum = sum + d.a %}{% set pick = pick + [d.r] %}{% endif %}{% endfor %}
      {{ pick | tojson }}

    final_on: >-
      {% set p1 = sel_p1|from_json(default=[]) %}
      {% set p2 = sel_p2|from_json(default=[]) %}
      {% set p3 = sel_p3|from_json(default=[]) %}
      {{ (p1 + p2 + p3) | unique | list | tojson }}

    # Switches
    sw_on: >-
      {% set F = final_on | from_json(default=[]) %}
      {{ F | map('regex_replace','^','switch.heating_') | list | tojson }}

    sw_off: >-
      {% set F = final_on | from_json(default=[]) %}
      {% set off = rooms_json | from_json(default=[]) | reject('in', F) | list %}
      {{ off | map('regex_replace','^','switch.heating_') | list | tojson }}

    # ------------------ Debug: kompakter JSON-Dump ------------------
    dbg: >-
      {% set dbg = {
        'ts': now().isoformat(),
        'offset_k': offset_k|float(0),
        'preheat_offset_k': preheat_offset_k|float(0),
        'pv_offset_k': pv_offset_k|float(0),
        'pv_forecast_w': pv_forecast_w|float(0),
        'pv_thr_w': pv_thr_w|float(0),
        'is_preheat': is_preheat_window,
        'C_eff_kWh_per_K': C_eff|float(0),
        'H_eff_kWh_per_K_day': H_eff|float(0),
        'dT_forecast_K': dT_forecast|float(0),
        't_set_eff': (t_set_eff|from_json(default={})),
        't_now':     (t_now|from_json(default={})),
        'terr':      (terr_map|from_json(default={})),
        'phase':     (phase_map|from_json(default={})),
        'amps':      (amps_map|from_json(default={})),
        'cand':      (cand_list|from_json(default=[])),
        'sel_p1':    (sel_p1|from_json(default=[])),
        'sel_p2':    (sel_p2|from_json(default=[])),
        'sel_p3':    (sel_p3|from_json(default=[])),
        'final_on':  (final_on|from_json(default=[])),
        'rooms_json': (rooms_json|from_json(default=[]))
      } %}
      {{ (dbg | tojson) | string }}
  condition: []
  action:
    - choose:
        # Optional: Setpoint anheben (effektiv) – nur wenn Offset > 0
        - conditions: "{{ offset_k|float(0) > 0 }}"
          sequence:
            - repeat:
                for_each: "{{ rooms_json | from_json(default=[]) }}"
                sequence:
                  - service: climate.set_temperature
                    target: { entity_id: "climate.raum_{{ repeat.item }}" }
                    data:
                      temperature: >-
                        {{ (t_set_eff|from_json)[repeat.item] | float }}
    # Erweiterter Debug-Eintrag
    - service: logbook.log
      data:
        name: "Heiz-Planer"
        message: "{{ dbg }}"
- id: '1760033014511'
  alias: Türschnapper
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_button.snapper_door
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: lock.home
        state: locked
      sequence:
      - action: lock.unlock
        metadata: {}
        data: {}
        target:
          entity_id: lock.home
  - action: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: switch.snapper_door
  - delay:
      hours: 0
      minutes: 0
      seconds: 3
      milliseconds: 0
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.snapper_door
  mode: single
- id: '1760033049182'
  alias: Rollade runter bei Sonnenuntergang
  description: ''
  triggers:
  - trigger: sun
    event: sunset
    offset: 00:30:00
  conditions: []
  actions:
  - action: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id:
      - cover.rollade_bad
      - cover.rollade_buero_fabian
      - cover.rollade_buero_merja
      - cover.rollade_hwr
      - cover.rollade_kueche_links
      - cover.rollade_kueche_rechts
      - cover.rollade_schlafzimmer
      - cover.rollade_speisekammer
      - cover.rollade_wohnzimmer_links
      - cover.rollade_wohnzimmer_rechts
  mode: single
- id: '1760034159712'
  alias: Water cycling
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.presence_bad
    to: 'on'
  - trigger: state
    entity_id:
    - binary_sensor.presence_bad
    to: 'off'
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: binary_sensor.presence_bad
        state:
        - 'on'
      - condition: time
        after: 07:00:00
        before: '22:00:00'
    - condition: state
      entity_id: binary_sensor.presence_bad
      state:
      - 'off'
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.presence_bad
        state: 'on'
      sequence:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.water_cycling_pump
    - conditions:
      - condition: state
        entity_id: binary_sensor.presence_bad
        state: 'off'
      sequence:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: switch.water_cycling_pump
  mode: single
- id: '1760792838672'
  alias: Turn off PoE when door locks
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - lock.home
    to: locked
  conditions: []
  actions:
  - type: turn_off
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: 98e8377d61e0ac7a353988c1511c4fd7
    domain: switch
  - type: turn_off
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: fac5b8708ea24f89fb09f34c1ec11399
    domain: switch
  - condition: time
    after: 08:02:00
    before: '21:59:00'
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.room_bad
      - light.room_buero_fabian
      - light.room_buero_merja
      - light.room_flur
      - light.room_kueche
      - light.room_schlafzimmer
      - light.room_speisekammer
      - light.room_wohnzimmer
  mode: single
- id: '1760793040596'
  alias: Turn on PoE when door unlocks
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - lock.home
    to: unlocked
  conditions: []
  actions:
  - type: turn_on
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: 98e8377d61e0ac7a353988c1511c4fd7
    domain: switch
  - type: turn_on
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: fac5b8708ea24f89fb09f34c1ec11399
    domain: switch
  - condition: time
    before: '21:59:00'
    after: 08:01:00
  - action: light.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.room_bad
      - light.room_buero_fabian
      - light.room_buero_merja
      - light.room_flur
      - light.room_kueche
      - light.room_schlafzimmer
      - light.room_speisekammer
      - light.room_wohnzimmer
  mode: single
- id: '1763464337854'
  alias: Battery override turn off
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_boolean.charge_solar_battery_override
    to:
    - 'on'
  conditions: []
  actions:
  - delay:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.charge_solar_battery_override
  mode: single
- id: '1763464703056'
  alias: Override off when battery over 75%
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.pv_battery1_state_of_charge
    for:
      hours: 0
      minutes: 2
      seconds: 0
    above: 75
  conditions: []
  actions:
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.charge_solar_battery_override
  mode: single
- id: '1764188802719'
  alias: Reset after 2 minutes
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - switch.water_cycling_pump
    to:
    - 'on'
  conditions: []
  actions:
  - delay:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.water_cycling_pump
  mode: single
- id: '1764330508231'
  alias: Tibber Preis-Schwellen 16:00 aktualisieren
  description: ''
  triggers:
  - trigger: time_pattern
    hours: '16'
    minutes: '0'
    seconds: '0'
  conditions: []
  actions:
  - action: script.update_tibber_price_thresholds
    data: {}
  mode: single
- id: '1764330601419'
  alias: Tibber Preis-Schwellen alle 30 Min auffrischen
  description: ''
  triggers:
  - trigger: time_pattern
    minutes: /30
  conditions: []
  actions:
  - action: script.update_tibber_price_thresholds
    metadata: {}
    data: {}
  mode: single
