- id: pwm_apply_plan_each_5min
  alias: "PWM: Plan anwenden (alle 5 min) – Bedarf + Phasenlimit 16A (rooms-driven)"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/5"
  variables:
    # zentrale Raumliste – nur hier pflegen
    rooms: ['bad','kueche','schlafzimmer','flur','speisekammer','wohnzimmer','buero_merja','buero_fabian']
    # aktueller Slotindex (0..5)
    s: "{{ states('sensor.pwm_slot_index')|string }}"
    # Slot-Plan je Raum (CSV -> wir splitten später)
    slots_csv: >-
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set ent = 'input_text.plan_slots_' ~ r %}
        {% set _ = ns.map.update({ r: (states(ent)|string) }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Switch-Entity je Raum (bevorzugt 'switch.', Fallback 'swtich.')
    sw_map: >-
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set a = 'switch.heating_' ~ r %}
        {% set b = 'swtich.heating_' ~ r %}
        {% set ok_a = (states(a) not in ['unknown','unavailable','None']) %}
        {% set ok_b = (states(b) not in ['unknown','unavailable','None']) %}
        {% set chosen = a if ok_a else (b if ok_b else a) %}
        {% set _ = ns.map.update({ r: chosen }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Climate-Entity je Raum
    cl_map: >-
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set _ = ns.map.update({ r: 'climate.room_' ~ r }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Bedarf (Ist < Soll - Hysterese)
    need_map: >-
      {% set H = 0.05 %}
      {% set cl = cl_map|from_json %}
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set ce = cl[r] %}
        {% set t = state_attr(ce,'temperature')|float(22) %}
        {% set x = state_attr(ce,'current_temperature')|float(t) %}
        {% set _ = ns.map.update({ r: (x < (t - H)) }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Temperaturfehler (für Priorität je Phase)
    terr_map: >-
      {% set cl = cl_map|from_json %}
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set ce = cl[r] %}
        {% set t = state_attr(ce,'temperature')|float(22) %}
        {% set x = state_attr(ce,'current_temperature')|float(t) %}
        {% set _ = ns.map.update({ r: (t - x) }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Geplanter Slot aktiv?
    onplan_map: >-
      {% set csv = slots_csv|from_json %}
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set lst = (csv[r]|string).split(',') if csv[r] else [] %}
        {% set _ = ns.map.update({ r: (s in lst) }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Phase je Raum automatisch aus Sensor-Namen ableiten (l1>l2>l3)
    phase_map: >-
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set l1 = 'sensor.current_l1_' ~ r ~ '_current' %}
        {% set l2 = 'sensor.current_l2_' ~ r ~ '_current' %}
        {% set l3 = 'sensor.current_l3_' ~ r ~ '_current' %}
        {% set p = 0 %}
        {% if states(l1) not in ['unknown','unavailable','None'] %}{% set p = 1 %}
        {% elif states(l2) not in ['unknown','unavailable','None'] %}{% set p = 2 %}
        {% elif states(l3) not in ['unknown','unavailable','None'] %}{% set p = 3 %}
        {% endif %}
        {% set _ = ns.map.update({ r: p }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Ampere je Raum (aus dem passenden lX-Current; 0 wenn kein Sensor)
    amps_map: >-
      {% set ns = namespace(map={}) %}
      {% for r in rooms %}
        {% set l1 = 'sensor.current_l1_' ~ r ~ '_current' %}
        {% set l2 = 'sensor.current_l2_' ~ r ~ '_current' %}
        {% set l3 = 'sensor.current_l3_' ~ r ~ '_current' %}
        {% set live = states(l1)|float(0) if states(l1) not in ['unknown','unavailable','None'] else
                      (states(l2)|float(0) if states(l2) not in ['unknown','unavailable','None'] else
                       (states(l3)|float(0) if states(l3) not in ['unknown','unavailable','None'] else 0)) %}
        {% set live_a = live/1000 if live>0 else 0 %}

        {% set sql_a = states('sensor.heater_' ~ r ~ '_max_current_a')|float(0) %}
        {% set rated = states('input_number.heater_' ~ r ~ '_rated_a')|float(0) %}

        {% set a = live_a if live_a>0 else (sql_a if sql_a>0 else rated) %}
        {% set _ = ns.map.update({ r: a }) %}
      {% endfor %}
      {{ ns.map|tojson }}
    # Kandidaten = geplanter Slot & Bedarf
    cand_list: >-
      {% set onp = onplan_map|from_json %}
      {% set need = need_map|from_json %}
      {% set out = [] %}
      {% for r in rooms %}
        {% if onp[r] and need[r] %}
          {% set out = out + [ r ] %}
        {% endif %}
      {% endfor %}
      {{ out|tojson }}
    # Hilfsfunktion: greedy Auswahl für eine Phase (als Liste der Räume)
    # (wir bauen eine Liste aus Dicts {r,e,a} und sortieren nach e absteigend)
    sel_p1: >-
      {% set PH=16.0 %}
      {% set ph = phase_map|from_json %}
      {% set er = terr_map |from_json %}
      {% set ar = amps_map |from_json %}
      {% set C  = cand_list|from_json %}
      {% set D = [] %}
      {% for r in C %}
        {% if ph[r]==1 %}
          {% set D = D + [ {'r': r, 'e': er[r]|float(0), 'a': ar[r]|float(0)} ] %}
        {% endif %}
      {% endfor %}
      {% set D = D|sort(attribute='e', reverse=True) %}
      {% set sum = 0.0 %}
      {% set pick = [] %}
      {% for d in D %}
        {% if sum + d.a <= PH %}
          {% set sum = sum + d.a %}
          {% set pick = pick + [ d.r ] %}
        {% endif %}
      {% endfor %}
      {{ pick|tojson }}
    sel_p2: >-
      {% set PH=16.0 %}
      {% set ph = phase_map|from_json %}
      {% set er = terr_map |from_json %}
      {% set ar = amps_map |from_json %}
      {% set C  = cand_list|from_json %}
      {% set D = [] %}
      {% for r in C %}
        {% if ph[r]==2 %}
          {% set D = D + [ {'r': r, 'e': er[r]|float(0), 'a': ar[r]|float(0)} ] %}
        {% endif %}
      {% endfor %}
      {% set D = D|sort(attribute='e', reverse=True) %}
      {% set sum = 0.0 %}
      {% set pick = [] %}
      {% for d in D %}
        {% if sum + d.a <= PH %}
          {% set sum = sum + d.a %}
          {% set pick = pick + [ d.r ] %}
        {% endif %}
      {% endfor %}
      {{ pick|tojson }}
    sel_p3: >-
      {% set PH=16.0 %}
      {% set ph = phase_map|from_json %}
      {% set er = terr_map |from_json %}
      {% set ar = amps_map |from_json %}
      {% set C  = cand_list|from_json %}
      {% set D = [] %}
      {% for r in C %}
        {% if ph[r]==3 %}
          {% set D = D + [ {'r': r, 'e': er[r]|float(0), 'a': ar[r]|float(0)} ] %}
        {% endif %}
      {% endfor %}
      {% set D = D|sort(attribute='e', reverse=True) %}
      {% set sum = 0.0 %}
      {% set pick = [] %}
      {% for d in D %}
        {% if sum + d.a <= PH %}
          {% set sum = sum + d.a %}
          {% set pick = pick + [ d.r ] %}
        {% endif %}
      {% endfor %}
      {{ pick|tojson }}
    # Finale Auswahl = Union p1+p2+p3
    final_on: >-
      {% set p1 = sel_p1|from_json %}
      {% set p2 = sel_p2|from_json %}
      {% set p3 = sel_p3|from_json %}
      {{ (p1 + p2 + p3)|unique|list|tojson }}
    # Switch-Listen ON/OFF
    to_on: >-
      {% set F = final_on|from_json %}
      {% set SW = sw_map|from_json %}
      {{ F | map('extract', SW) | list | tojson }}
    to_off: >-
      {% set F = final_on|from_json %}
      {% set SW = sw_map|from_json %}
      {% set off = rooms | reject('in', F) | list %}
      {{ off | map('extract', SW) | list | tojson }}
  action:
    - service: switch.turn_on_disabled
      target: { entity_id: "{{ to_on|from_json }}" }
    - service: switch.turn_off_disabled
      target: { entity_id: "{{ to_off|from_json }}" }
- id: '1760033014511'
  alias: Türschnapper
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_button.snapper_door
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: lock.home
        state: locked
      sequence:
      - action: lock.unlock
        metadata: {}
        data: {}
        target:
          entity_id: lock.home
  - action: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: switch.snapper_door
  - delay:
      hours: 0
      minutes: 0
      seconds: 3
      milliseconds: 0
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.snapper_door
  mode: single
- id: '1760033049182'
  alias: Rollade runter bei Sonnenuntergang
  description: ''
  triggers:
  - trigger: sun
    event: sunset
    offset: 00:30:00
  conditions: []
  actions:
  - action: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id:
      - cover.rollade_bad
      - cover.rollade_buero_fabian
      - cover.rollade_buero_merja
      - cover.rollade_hwr
      - cover.rollade_kueche_links
      - cover.rollade_kueche_rechts
      - cover.rollade_schlafzimmer
      - cover.rollade_speisekammer
      - cover.rollade_wohnzimmer_links
      - cover.rollade_wohnzimmer_rechts
  mode: single
- id: '1760034159712'
  alias: Water cycling
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.presence_bad
    to: 'on'
  - trigger: state
    entity_id:
    - binary_sensor.presence_bad
    to: 'off'
  conditions:
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: binary_sensor.presence_bad
        state:
        - 'on'
      - condition: time
        after: 07:00:00
        before: '22:00:00'
    - condition: state
      entity_id: binary_sensor.presence_bad
      state:
      - 'off'
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.presence_bad
        state: 'on'
      sequence:
      - action: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.water_cycling_pump
    - conditions:
      - condition: state
        entity_id: binary_sensor.presence_bad
        state: 'off'
      sequence:
      - action: switch.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: switch.water_cycling_pump
  mode: single
- id: '1760792838672'
  alias: Turn off PoE when door locks
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - lock.home
    to: locked
  conditions: []
  actions:
  - type: turn_off
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: 98e8377d61e0ac7a353988c1511c4fd7
    domain: switch
  - type: turn_off
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: fac5b8708ea24f89fb09f34c1ec11399
    domain: switch
  - condition: time
    after: 08:02:00
    before: '21:59:00'
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.room_bad
      - light.room_buero_fabian
      - light.room_buero_merja
      - light.room_flur
      - light.room_kueche
      - light.room_schlafzimmer
      - light.room_speisekammer
      - light.room_wohnzimmer
  mode: single
- id: '1760793040596'
  alias: Turn on PoE when door unlocks
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - lock.home
    to: unlocked
  conditions: []
  actions:
  - type: turn_on
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: 98e8377d61e0ac7a353988c1511c4fd7
    domain: switch
  - type: turn_on
    device_id: a0fc21070bd65c1c856cb76779093e8d
    entity_id: fac5b8708ea24f89fb09f34c1ec11399
    domain: switch
  - condition: time
    before: '21:59:00'
    after: 08:01:00
  - action: light.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - light.room_bad
      - light.room_buero_fabian
      - light.room_buero_merja
      - light.room_flur
      - light.room_kueche
      - light.room_schlafzimmer
      - light.room_speisekammer
      - light.room_wohnzimmer
  mode: single
- id: '1763464337854'
  alias: Battery override turn off
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - input_boolean.charge_solar_battery_override
    to:
    - 'on'
  conditions: []
  actions:
  - delay:
      hours: 2
      minutes: 0
      seconds: 0
      milliseconds: 0
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.charge_solar_battery_override
  mode: single
- id: '1763464703056'
  alias: Override off when battery over 75%
  description: ''
  triggers:
  - trigger: numeric_state
    entity_id:
    - sensor.pv_battery1_state_of_charge
    for:
      hours: 0
      minutes: 2
      seconds: 0
    above: 75
  conditions: []
  actions:
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.charge_solar_battery_override
  mode: single
- id: '1764188802719'
  alias: Reset after 2 minutes
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - switch.water_cycling_pump
    to:
    - 'on'
  conditions: []
  actions:
  - delay:
      hours: 0
      minutes: 2
      seconds: 0
      milliseconds: 0
  - action: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.water_cycling_pump
  mode: single
- id: '1764330508231'
  alias: Tibber Preis-Schwellen 16:00 aktualisieren
  description: ''
  triggers:
  - trigger: time_pattern
    hours: '16'
    minutes: '0'
    seconds: '0'
  conditions: []
  actions:
  - action: script.update_tibber_price_thresholds
    data: {}
  mode: single
- id: '1764330601419'
  alias: Tibber Preis-Schwellen alle 30 Min auffrischen
  description: ''
  triggers:
  - trigger: time_pattern
    minutes: /30
  conditions: []
  actions:
  - action: script.update_tibber_price_thresholds
    metadata: {}
    data: {}
  mode: single
