- id: heating_plan_every_5min
  alias: "Heizung: Planung alle 5 Minuten (PV/Preheat/Phasen)"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/5"
  variables:
    # ===================================================================
    # SECTION 1: CONFIGURATION & GLOBAL PARAMETERS
    # ===================================================================
    rooms_json: '["bad","kueche","schlafzimmer","flur","speisekammer","wohnzimmer","buero_merja","buero_fabian"]'
    phase_max_amps: 16.0
    hysteresis_k: 0.05
    
    # PV and preheat parameters
    pv_forecast_w: "{{ states('sensor.solcast_pv_forecast_leistung_in_30_minuten') | float(0) }}"
    pv_thr_w: "{{ states('input_number.pv_excess_threshold_w') | float(0) }}"
    has_pv_excess: "{{ pv_forecast_w > pv_thr_w }}"
    pv_offset_k: "{{ 0.5 if has_pv_excess else 0 }}"
    
    is_preheat_window: >-
      {% set current_ts = as_timestamp(now()) %}
      {% set window_start = as_timestamp(now().replace(hour=0, minute=0, second=0, microsecond=0)) %}
      {% set window_end = as_timestamp(now().replace(hour=6, minute=0, second=0, microsecond=0)) %}
      {{ window_start <= current_ts < window_end }}
    
    C_eff: "{{ states('sensor.C_kWh_per_K_rolling') | float(10) }}"
    H_eff: "{{ states('sensor.H_kW_per_K_rolling_sql') | float(6.25) }}"
    dT_forecast: "{{ states('input_number.delta_t_forecast_k') | float(0) }}"
    
    preheat_offset_k: >-
      {% set heat_capacity = C_eff | float(0) %}
      {% set heating_power = H_eff | float(0) %}
      {% set temp_drop = dT_forecast | float(0) %}
      {% set energy_needed_kwh = heating_power * temp_drop %}
      {% set offset_raw = (energy_needed_kwh / heat_capacity) if heat_capacity > 0 else 0 %}
      {% if not is_preheat_window %}
        0
      {% else %}
        {% set offset_clamped_low = 0.2 if offset_raw < 0.2 else offset_raw %}
        {% set offset_clamped = 0.6 if offset_clamped_low > 0.6 else offset_clamped_low %}
        {{ offset_clamped }}
      {% endif %}
    
    offset_k: >-
      {% set preheat = preheat_offset_k | float(0) %}
      {% set pv = pv_offset_k | float(0) %}
      {% set total = preheat + pv %}
      {% if total < 0 %}
        0
      {% elif total > 0.6 %}
        0.6
      {% else %}
        {{ total }}
      {% endif %}
    
    # ===================================================================
    # SECTION 2: COMPREHENSIVE ROOM DATA (Single Pass)
    # ===================================================================
    # Build all room data in one pass - no JSON parsing needed!
    room_data: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set offset = offset_k | float(0) %}
      {% set hyst = hysteresis_k | float(0.05) %}
      {% set invalid_states = ['unknown', 'unavailable', 'None', ''] %}
      {% set ns = namespace(rooms = {}) %}
      
      {% for room in rooms %}
        {% set climate_entity = 'climate.room_' ~ room %}
        {% set sensor_l1 = 'sensor.current_l1_' ~ room ~ '_current' %}
        {% set sensor_l2 = 'sensor.current_l2_' ~ room ~ '_current' %}
        {% set sensor_l3 = 'sensor.current_l3_' ~ room ~ '_current' %}
        
        {# Read temperatures #}
        {% set current_temp = state_attr(climate_entity, 'current_temperature') %}
        {% set target_temp = state_attr(climate_entity, 'temperature') %}
        {% if current_temp is number %}
          {% set current = current_temp | float %}
        {% else %}
          {% set current = 22.0 %}
        {% endif %}
        {% if target_temp is number %}
          {% set base_target = target_temp | float %}
        {% else %}
          {% set base_target = 22.0 %}
        {% endif %}
        {% set effective_target = base_target + offset %}
        {% set error = effective_target - current %}
        
        {# Determine phase #}
        {% set phase = 0 %}
        {% if states(sensor_l1) not in invalid_states %}
          {% set phase = 1 %}
        {% elif states(sensor_l2) not in invalid_states %}
          {% set phase = 2 %}
        {% elif states(sensor_l3) not in invalid_states %}
          {% set phase = 3 %}
        {% endif %}
        
        {# Get current consumption #}
        {% set live_current_ma = 0 %}
        {% if states(sensor_l1) not in invalid_states %}
          {% set live_current_ma = states(sensor_l1) | float(0) %}
        {% elif states(sensor_l2) not in invalid_states %}
          {% set live_current_ma = states(sensor_l2) | float(0) %}
        {% elif states(sensor_l3) not in invalid_states %}
          {% set live_current_ma = states(sensor_l3) | float(0) %}
        {% endif %}
        {% if live_current_ma > 0 %}
          {% set live_current_a = live_current_ma / 1000 %}
        {% else %}
          {% set live_current_a = 0 %}
        {% endif %}
        {% set sql_current_a = states('sensor.heater_' ~ room ~ '_max_current_a') | float(0) %}
        {% set rated_current_a = states('input_number.heater_' ~ room ~ '_rated_a') | float(0) %}
        {% if live_current_a > 0 %}
          {% set amps = live_current_a %}
        {% elif sql_current_a > 0 %}
          {% set amps = sql_current_a %}
        {% else %}
          {% set amps = rated_current_a %}
        {% endif %}
        
        {# Determine if heating is needed #}
        {% set threshold = effective_target - hyst %}
        {% set needs_heating = current < threshold %}
        
        {# Build room data structure #}
        {% set ns.rooms = ns.rooms | combine({ 
          room: {
            'entity': climate_entity,
            'current_temp': current,
            'base_target': base_target,
            'effective_target': effective_target,
            'error': error,
            'phase': phase,
            'amps': amps,
            'needs_heating': needs_heating
          }
        }) %}
      {% endfor %}
      {{ (ns.rooms | tojson) | string }}
    
    # ===================================================================
    # SECTION 3: ROOM SELECTION BY PHASE
    # ===================================================================
    # Select rooms for each phase using greedy algorithm
    sel_p1: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(room_list = [], selected = []) %}
      {% for room, data in rooms_data.items() %}
        {% if data.phase == 1 and data.needs_heating %}
          {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
        {% endif %}
      {% endfor %}
      {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
      {% set total = 0.0 %}
      {% for item in sorted %}
        {% if total + item.amps <= max_amps %}
          {% set total = total + item.amps %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    sel_p2: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(room_list = [], selected = []) %}
      {% for room, data in rooms_data.items() %}
        {% if data.phase == 2 and data.needs_heating %}
          {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
        {% endif %}
      {% endfor %}
      {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
      {% set total = 0.0 %}
      {% for item in sorted %}
        {% if total + item.amps <= max_amps %}
          {% set total = total + item.amps %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    sel_p3: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(room_list = [], selected = []) %}
      {% for room, data in rooms_data.items() %}
        {% if data.phase == 3 and data.needs_heating %}
          {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
        {% endif %}
      {% endfor %}
      {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
      {% set total = 0.0 %}
      {% for item in sorted %}
        {% if total + item.amps <= max_amps %}
          {% set total = total + item.amps %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    final_on: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(final = []) %}
      {% for phase_num in [1, 2, 3] %}
        {% set ns.room_list = [] %}
        {% for room, data in rooms_data.items() %}
          {% if data.phase == phase_num and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endfor %}
        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
        {% set total = 0.0 %}
        {% for item in sorted %}
          {% if total + item.amps <= max_amps %}
            {% set total = total + item.amps %}
            {% if item.room not in ns.final %}
              {% set ns.final = ns.final + [item.room] %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {{ (ns.final | tojson) | string }}
    
    # ===================================================================
    # SECTION 4: SWITCH ENTITY MAPPING
    # ===================================================================
    sw_on: >-
      {% set rooms_to_heat = final_on | from_json(default=[]) %}
      {% set switches = [] %}
      {% for room in rooms_to_heat %}
        {% set switches = switches + ['switch.heating_' ~ room] %}
      {% endfor %}
      {{ (switches | tojson) | string }}
    
    sw_off: >-
      {% set rooms_to_heat = final_on | from_json(default=[]) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set switches = [] %}
      {% for room in all_rooms %}
        {% if room not in rooms_to_heat %}
          {% set switches = switches + ['switch.heating_' ~ room] %}
        {% endif %}
      {% endfor %}
      {{ (switches | tojson) | string }}
    
    # ===================================================================
    # SECTION 5: DEBUG OUTPUT
    # ===================================================================
    dbg: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(candidates = [], sel_p1_list = [], sel_p2_list = [], sel_p3_list = []) %}
      
      # Build candidates list
      {% for room, data in rooms_data.items() %}
        {% if data.needs_heating %}
          {% set ns.candidates = ns.candidates + [room] %}
        {% endif %}
      {% endfor %}
      
      # Build selections (same logic as sel_p1/2/3 but inline)
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% for phase_num in [1, 2, 3] %}
        {% set ns.room_list = [] %}
        {% for room, data in rooms_data.items() %}
          {% if data.phase == phase_num and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endfor %}
        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
        {% set total = 0.0 %}
        {% set selected = [] %}
        {% for item in sorted %}
          {% if total + item.amps <= max_amps %}
            {% set total = total + item.amps %}
            {% set selected = selected + [item.room] %}
          {% endif %}
        {% endfor %}
        {% if phase_num == 1 %}
          {% set ns.sel_p1_list = selected %}
        {% elif phase_num == 2 %}
          {% set ns.sel_p2_list = selected %}
        {% elif phase_num == 3 %}
          {% set ns.sel_p3_list = selected %}
        {% endif %}
      {% endfor %}
      
      {% set ns.temps_current = {} %}
      {% set ns.temps_base = {} %}
      {% set ns.temps_eff = {} %}
      {% set ns.errors_dict = {} %}
      {% set ns.phases_dict = {} %}
      {% set ns.amps_dict = {} %}
      {% set ns.needs_dict = {} %}
      {% for room, data in rooms_data.items() %}
        {% set ns.temps_current = ns.temps_current | combine({room: data.current_temp}) %}
        {% set ns.temps_base = ns.temps_base | combine({room: data.base_target}) %}
        {% set ns.temps_eff = ns.temps_eff | combine({room: data.effective_target}) %}
        {% set ns.errors_dict = ns.errors_dict | combine({room: data.error}) %}
        {% set ns.phases_dict = ns.phases_dict | combine({room: data.phase}) %}
        {% set ns.amps_dict = ns.amps_dict | combine({room: data.amps}) %}
        {% set ns.needs_dict = ns.needs_dict | combine({room: data.needs_heating}) %}
      {% endfor %}
      
      {% set debug_data = {
        'timestamp': now().isoformat(),
        'offsets': {
          'total_k': offset_k | float(0),
          'preheat_k': preheat_offset_k | float(0),
          'pv_k': pv_offset_k | float(0)
        },
        'pv': {
          'forecast_w': pv_forecast_w | float(0),
          'threshold_w': pv_thr_w | float(0),
          'has_excess': has_pv_excess
        },
        'preheat': {
          'is_window': is_preheat_window,
          'window_active': is_preheat_window
        },
        'thermal': {
          'C_eff_kWh_per_K': C_eff | float(0),
          'H_eff_kW_per_K': H_eff | float(0),
          'dT_forecast_K': dT_forecast | float(0)
        },
        'temperatures': {
          'current': ns.temps_current,
          'set_base': ns.temps_base,
          'set_effective': ns.temps_eff
        },
        'errors': ns.errors_dict,
        'phases': ns.phases_dict,
        'currents_amps': ns.amps_dict,
        'needs_heating': ns.needs_dict,
        'candidates': ns.candidates,
        'selected': {
          'phase_1': ns.sel_p1_list,
          'phase_2': ns.sel_p2_list,
          'phase_3': ns.sel_p3_list,
          'final': (ns.sel_p1_list + ns.sel_p2_list + ns.sel_p3_list) | unique | list
        },
        'switches': {
          'on': sw_on | from_json(default=[]),
          'off': sw_off | from_json(default=[])
        }
      } %}
      {{ (debug_data | tojson) | string }}
  
  condition: []
  action:
    # ===================================================================
    # ACTION 1: Update temperature setpoints if offset is active
    # ===================================================================
    - choose:
        - conditions: "{{ offset_k | float(0) > 0 }}"
          sequence:
            - service: logbook.log
              data:
                name: "Heiz-Planer"
                message: "Offset aktiv: {{ offset_k | float(0) }}K (PV: {{ pv_offset_k | float(0) }}K, Preheat: {{ preheat_offset_k | float(0) }}K)"
            - repeat:
                for_each: "{{ rooms_json | from_json(default=[]) }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "climate.room_{{ repeat.item }}"
                    data:
                      temperature: >-
                        {% set rooms_data = room_data | from_json(default={}) %}
                        {{ rooms_data[repeat.item].effective_target | float }}
    
    # ===================================================================
    # ACTION 2: Log debug information
    # ===================================================================
    - service: logbook.log
      data:
        name: "Heiz-Planer"
        message: "{{ dbg }}"
    
    # ===================================================================
    # ACTION 3: Control heating switches
    # ===================================================================
    - parallel:
        # Turn ON switches for selected rooms
        - service: switch.turn_on
          target:
            entity_id: "{{ sw_on | from_json(default=[]) }}"
        # Turn OFF switches for non-selected rooms
        - service: switch.turn_off
          target:
            entity_id: "{{ sw_off | from_json(default=[]) }}"
