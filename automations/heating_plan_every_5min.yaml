- id: heating_plan_every_5min
  alias: "Heizung: Planung alle 5 Minuten (PV/Preheat/Phasen)"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/5"
  variables:
    # ===================================================================
    # SECTION 1: ROOM CONFIGURATION
    # ===================================================================
    # Central room list - modify here to add/remove rooms
    rooms_json: '["bad","kueche","schlafzimmer","flur","speisekammer","wohnzimmer","buero_merja","buero_fabian"]'
    
    # Map each room to its climate entity (e.g., "bad" -> "climate.raum_bad")
    cl_map: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set climate_entity = 'climate.raum_' ~ room %}
        {% set ns.m = ns.m | combine({ room: climate_entity }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse climate map once for reuse
    cl_map_parsed: "{{ cl_map | from_json(default={}) }}"
    
    # ===================================================================
    # SECTION 2: TEMPERATURE READINGS
    # ===================================================================
    # Base target temperature (setpoint) for each room
    t_set_base: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set climate_entity = 'climate.raum_' ~ room %}
        {% set target_temp = state_attr(climate_entity, 'temperature') %}
        {% if target_temp is none or target_temp == 'unknown' or target_temp == 'unavailable' %}
          {% set temp_float = 22.0 %}
        {% else %}
          {% set temp_float = target_temp | float(22) %}
        {% endif %}
        {% set ns.m = ns.m | combine({ room: temp_float }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Current temperature for each room
    t_now: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set climate_entity = 'climate.raum_' ~ room %}
        {% set current_temp = state_attr(climate_entity, 'current_temperature') %}
        {% if current_temp is none or current_temp == 'unknown' or current_temp == 'unavailable' %}
          {% set temp_float = 22.0 %}
        {% else %}
          {% set temp_float = current_temp | float(22) %}
        {% endif %}
        {% set ns.m = ns.m | combine({ room: temp_float }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse temperature maps once for reuse
    t_set_base_parsed: "{{ t_set_base | from_json(default={}) }}"
    t_now_parsed: "{{ t_now | from_json(default={}) }}"
    
    # Debug: Test reading a single temperature to verify state_attr works
    dbg_test_temp: "{{ state_attr('climate.raum_bad', 'temperature') }}"
    dbg_test_current: "{{ state_attr('climate.raum_bad', 'current_temperature') }}"
    dbg_test_state: "{{ states('climate.raum_bad') }}"
    
    # ===================================================================
    # SECTION 3: PV EXCESS DETECTION
    # ===================================================================
    # PV forecast: Expected power generation in next 30 minutes (Watts)
    pv_forecast_w: "{{ states('sensor.solcast_pv_forecast_leistung_in_30_minuten') | float(0) }}"
    
    # PV threshold: Minimum excess power required to enable PV offset (Watts)
    pv_thr_w: "{{ states('input_number.pv_excess_threshold_w') | float(0) }}"
    
    # Check if we have excess PV power available
    has_pv_excess: "{{ pv_forecast_w > pv_thr_w }}"
    
    # ===================================================================
    # SECTION 4: PREHEAT WINDOW DETECTION
    # ===================================================================
    # Check if current time is within preheat window (00:00 - 06:00)
    is_preheat_window: >-
      {% set current_ts = as_timestamp(now()) %}
      {% set window_start = as_timestamp(now().replace(hour=0, minute=0, second=0, microsecond=0)) %}
      {% set window_end = as_timestamp(now().replace(hour=6, minute=0, second=0, microsecond=0)) %}
      {{ window_start <= current_ts < window_end }}
    
    # ===================================================================
    # SECTION 5: THERMAL PARAMETERS
    # ===================================================================
    # Effective heat capacity (kWh per Kelvin)
    C_eff: "{{ states('sensor.C_kWh_per_K_rolling') | float(10) }}"
    
    # Effective heating power (kW per Kelvin)
    H_eff: "{{ states('sensor.H_kW_per_K_rolling_sql') | float(6.25) }}"
    
    # Forecasted temperature drop (Kelvin)
    dT_forecast: "{{ states('input_number.delta_t_forecast_k') | float(0) }}"
    
    # ===================================================================
    # SECTION 6: TEMPERATURE OFFSET CALCULATION
    # ===================================================================
    # PV offset: Add 0.5K when excess PV is available
    pv_offset_k: "{{ 0.5 if has_pv_excess else 0 }}"
    
    # Preheat offset: Calculated based on forecasted temperature drop
    # Clamped between 0.2K and 0.6K, only active during preheat window
    preheat_offset_k: >-
      {% set heat_capacity = C_eff | float(0) %}
      {% set heating_power = H_eff | float(0) %}
      {% set temp_drop = dT_forecast | float(0) %}
      {% set energy_needed_kwh = heating_power * temp_drop %}
      {% set offset_raw = (energy_needed_kwh / heat_capacity) if heat_capacity > 0 else 0 %}
      
      {% if not is_preheat_window %}
        0
      {% else %}
        {% set offset_clamped_low = 0.2 if offset_raw < 0.2 else offset_raw %}
        {% set offset_clamped = 0.6 if offset_clamped_low > 0.6 else offset_clamped_low %}
        {{ offset_clamped }}
      {% endif %}
    
    # Total offset: Sum of PV and preheat offsets, clamped to 0..0.6K
    offset_k: >-
      {% set preheat = preheat_offset_k | float(0) %}
      {% set pv = pv_offset_k | float(0) %}
      {% set total = preheat + pv %}
      {% if total < 0 %}
        0
      {% elif total > 0.6 %}
        0.6
      {% else %}
        {{ total }}
      {% endif %}
    
    # Effective target temperature: Base temperature + offset for each room
    t_set_eff: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set base_temps = t_set_base | from_json(default={}) %}
      {% set offset = offset_k | float(0) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set base_temp = base_temps.get(room, 22) %}
        {% set effective_temp = base_temp + offset %}
        {% set ns.m = ns.m | combine({ room: effective_temp }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse effective temperature map
    t_set_eff_parsed: "{{ t_set_eff | from_json(default={}) }}"
    
    # ===================================================================
    # SECTION 7: PHASE DETECTION
    # ===================================================================
    # Map each room to its electrical phase (1, 2, or 3)
    # Determined by checking which current sensor has valid data
    phase_map: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set sensor_l1 = 'sensor.current_l1_' ~ room ~ '_current' %}
        {% set sensor_l2 = 'sensor.current_l2_' ~ room ~ '_current' %}
        {% set sensor_l3 = 'sensor.current_l3_' ~ room ~ '_current' %}
        {% set invalid_states = ['unknown', 'unavailable', 'None', ''] %}
        
        {% set phase = 0 %}
        {% if states(sensor_l1) not in invalid_states %}
          {% set phase = 1 %}
        {% elif states(sensor_l2) not in invalid_states %}
          {% set phase = 2 %}
        {% elif states(sensor_l3) not in invalid_states %}
          {% set phase = 3 %}
        {% endif %}
        
        {% set ns.m = ns.m | combine({ room: phase }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse phase map
    phase_map_parsed: "{{ phase_map | from_json(default={}) }}"
    
    # ===================================================================
    # SECTION 8: CURRENT (AMPS) DETECTION
    # ===================================================================
    # Map each room to its current consumption (Amperes)
    # Priority: live current > SQL max current > rated current
    amps_map: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set sensor_l1 = 'sensor.current_l1_' ~ room ~ '_current' %}
        {% set sensor_l2 = 'sensor.current_l2_' ~ room ~ '_current' %}
        {% set sensor_l3 = 'sensor.current_l3_' ~ room ~ '_current' %}
        {% set invalid_states = ['unknown', 'unavailable', 'None', ''] %}
        
        {% set live_current_ma = 0 %}
        {% if states(sensor_l1) not in invalid_states %}
          {% set live_current_ma = states(sensor_l1) | float(0) %}
        {% elif states(sensor_l2) not in invalid_states %}
          {% set live_current_ma = states(sensor_l2) | float(0) %}
        {% elif states(sensor_l3) not in invalid_states %}
          {% set live_current_ma = states(sensor_l3) | float(0) %}
        {% endif %}
        
        {% set live_current_a = live_current_ma / 1000 if live_current_ma > 0 else 0 %}
        {% set sql_current_a = states('sensor.heater_' ~ room ~ '_max_current_a') | float(0) %}
        {% set rated_current_a = states('input_number.heater_' ~ room ~ '_rated_a') | float(0) %}
        
        {% set final_current = live_current_a if live_current_a > 0 else (sql_current_a if sql_current_a > 0 else rated_current_a) %}
        {% set ns.m = ns.m | combine({ room: final_current }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse amps map
    amps_map_parsed: "{{ amps_map | from_json(default={}) }}"
    
    # ===================================================================
    # SECTION 9: TEMPERATURE ERROR CALCULATION
    # ===================================================================
    # Temperature error: Difference between effective target and current temp
    # Positive = too cold (needs heating), Negative = too warm
    terr_map: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set current_temps = t_now | from_json(default={}) %}
      {% set target_temps = t_set_eff | from_json(default={}) %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set current = current_temps.get(room, 22) %}
        {% set target = target_temps.get(room, 22) %}
        {% set error = target - current %}
        {% set ns.m = ns.m | combine({ room: error }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse temperature error map
    terr_map_parsed: "{{ terr_map | from_json(default={}) }}"
    
    # ===================================================================
    # SECTION 10: HEATING NEED DETECTION
    # ===================================================================
    # Determine if each room needs heating
    # Room needs heating if current temp < (target temp - 0.05K hysteresis)
    need_map: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set current_temps = t_now | from_json(default={}) %}
      {% set target_temps = t_set_eff | from_json(default={}) %}
      {% set hysteresis_k = 0.05 %}
      {% set ns = namespace(m = {}) %}
      {% for room in rooms %}
        {% set current = current_temps.get(room, 22) %}
        {% set target = target_temps.get(room, 22) %}
        {% set threshold = target - hysteresis_k %}
        {% set needs_heating = current < threshold %}
        {% set ns.m = ns.m | combine({ room: needs_heating }) %}
      {% endfor %}
      {{ (ns.m | tojson) | string }}
    
    # Helper: Parse need map
    need_map_parsed: "{{ need_map | from_json(default={}) }}"
    
    # List of candidate rooms that need heating
    cand_list: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set needs = need_map | from_json(default={}) %}
      {% set ns = namespace(out = []) %}
      {% for room in rooms %}
        {% if needs.get(room, false) %}
          {% set ns.out = ns.out + [room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.out | tojson) | string }}
    
    # Helper: Parse candidate list
    cand_list_parsed: "{{ cand_list | from_json(default=[]) }}"
    
    # ===================================================================
    # SECTION 11: PHASE-BASED ROOM SELECTION
    # ===================================================================
    # Select rooms for each phase using greedy algorithm
    # - Sort candidates by temperature error (largest first)
    # - Add rooms until phase limit (16A) is reached
    # - Each phase is processed independently
    
    # Maximum current per phase (Amperes)
    phase_max_amps: 16.0
    
    # Selection for Phase 1
    sel_p1: >-
      {% set max_amps = phase_max_amps %}
      {% set phases = phase_map | from_json(default={}) %}
      {% set errors = terr_map | from_json(default={}) %}
      {% set currents = amps_map | from_json(default={}) %}
      {% set candidates = cand_list | from_json(default=[]) %}
      
      {% set ns = namespace(room_data = [], selected = []) %}
      {% for room in candidates %}
        {% if phases.get(room, 0) == 1 %}
          {% set room_dict = {'room': room, 'error': errors.get(room, 0) | float(0), 'amps': currents.get(room, 0) | float(0)} %}
          {% set ns.room_data = ns.room_data + [room_dict] %}
        {% endif %}
      {% endfor %}
      
      {% set sorted_data = ns.room_data | sort(attribute='error', reverse=True) %}
      {% set total_amps = 0.0 %}
      {% set ns.selected = [] %}
      {% for item in sorted_data %}
        {% if total_amps + item.amps <= max_amps %}
          {% set total_amps = total_amps + item.amps %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    # Selection for Phase 2
    sel_p2: >-
      {% set max_amps = phase_max_amps %}
      {% set phases = phase_map | from_json(default={}) %}
      {% set errors = terr_map | from_json(default={}) %}
      {% set currents = amps_map | from_json(default={}) %}
      {% set candidates = cand_list | from_json(default=[]) %}
      
      {% set ns = namespace(room_data = [], selected = []) %}
      {% for room in candidates %}
        {% if phases.get(room, 0) == 2 %}
          {% set room_dict = {'room': room, 'error': errors.get(room, 0) | float(0), 'amps': currents.get(room, 0) | float(0)} %}
          {% set ns.room_data = ns.room_data + [room_dict] %}
        {% endif %}
      {% endfor %}
      
      {% set sorted_data = ns.room_data | sort(attribute='error', reverse=True) %}
      {% set total_amps = 0.0 %}
      {% set ns.selected = [] %}
      {% for item in sorted_data %}
        {% if total_amps + item.amps <= max_amps %}
          {% set total_amps = total_amps + item.amps %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    # Selection for Phase 3
    sel_p3: >-
      {% set max_amps = phase_max_amps %}
      {% set phases = phase_map | from_json(default={}) %}
      {% set errors = terr_map | from_json(default={}) %}
      {% set currents = amps_map | from_json(default={}) %}
      {% set candidates = cand_list | from_json(default=[]) %}
      
      {% set ns = namespace(room_data = [], selected = []) %}
      {% for room in candidates %}
        {% if phases.get(room, 0) == 3 %}
          {% set room_dict = {'room': room, 'error': errors.get(room, 0) | float(0), 'amps': currents.get(room, 0) | float(0)} %}
          {% set ns.room_data = ns.room_data + [room_dict] %}
        {% endif %}
      {% endfor %}
      
      {% set sorted_data = ns.room_data | sort(attribute='error', reverse=True) %}
      {% set total_amps = 0.0 %}
      {% set ns.selected = [] %}
      {% for item in sorted_data %}
        {% if total_amps + item.amps <= max_amps %}
          {% set total_amps = total_amps + item.amps %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    # Helper: Parse phase selections
    sel_p1_parsed: "{{ sel_p1 | from_json(default=[]) }}"
    sel_p2_parsed: "{{ sel_p2 | from_json(default=[]) }}"
    sel_p3_parsed: "{{ sel_p3 | from_json(default=[]) }}"
    
    # Final list of rooms to turn ON (union of all phases, deduplicated)
    final_on: >-
      {% set p1 = sel_p1 | from_json(default=[]) %}
      {% set p2 = sel_p2 | from_json(default=[]) %}
      {% set p3 = sel_p3 | from_json(default=[]) %}
      {{ (p1 + p2 + p3) | unique | list | tojson }}
    
    # Helper: Parse final selection
    final_on_parsed: "{{ final_on | from_json(default=[]) }}"
    
    # ===================================================================
    # SECTION 12: SWITCH ENTITY MAPPING
    # ===================================================================
    # Convert room names to switch entity IDs for rooms to turn ON
    sw_on: >-
      {% set rooms_to_heat = final_on_parsed %}
      {% set switch_prefix = 'switch.heating_' %}
      {% set switches = [] %}
      {% for room in rooms_to_heat %}
        {% set switch_entity = switch_prefix ~ room %}
        {% set switches = switches + [switch_entity] %}
      {% endfor %}
      {{ (switches | tojson) | string }}
    
    # Convert room names to switch entity IDs for rooms to turn OFF
    sw_off: >-
      {% set rooms_to_heat = final_on | from_json(default=[]) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set rooms_to_off = [] %}
      {% for room in all_rooms %}
        {% if room not in rooms_to_heat %}
          {% set rooms_to_off = rooms_to_off + [room] %}
        {% endif %}
      {% endfor %}
      {% set switch_prefix = 'switch.heating_' %}
      {% set switches = [] %}
      {% for room in rooms_to_off %}
        {% set switch_entity = switch_prefix ~ room %}
        {% set switches = switches + [switch_entity] %}
      {% endfor %}
      {{ (switches | tojson) | string }}
    
    # ===================================================================
    # SECTION 13: DEBUG INFORMATION
    # ===================================================================
    # Debug: Check if cl_map is accessible and what it contains
    dbg_cl_map_raw: "{{ cl_map }}"
    dbg_cl_map_parsed: "{{ cl_map | from_json(default={}) }}"
    dbg_rooms_json: "{{ rooms_json }}"
    
    # Comprehensive debug output with all key variables
    dbg: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set climate_map_debug = {} %}
      {% for room in rooms %}
        {% set climate_entity = 'climate.raum_' ~ room %}
        {% set climate_map_debug = climate_map_debug | combine({ room: climate_entity }) %}
      {% endfor %}
      
      {% set debug_data = {
        'timestamp': now().isoformat(),
        'debug': {
          'cl_map_raw': cl_map,
          'cl_map_parsed': cl_map | from_json(default={}),
          'cl_map_rebuilt': climate_map_debug,
          'rooms_json': rooms_json,
          'rooms_list': rooms,
          'test_temp': dbg_test_temp,
          'test_current': dbg_test_current,
          'test_state': dbg_test_state,
          't_set_base_raw': t_set_base,
          't_now_raw': t_now
        },
        'offsets': {
          'total_k': offset_k | float(0),
          'preheat_k': preheat_offset_k | float(0),
          'pv_k': pv_offset_k | float(0)
        },
        'pv': {
          'forecast_w': pv_forecast_w | float(0),
          'threshold_w': pv_thr_w | float(0),
          'has_excess': has_pv_excess
        },
        'preheat': {
          'is_window': is_preheat_window,
          'window_active': is_preheat_window
        },
        'thermal': {
          'C_eff_kWh_per_K': C_eff | float(0),
          'H_eff_kW_per_K': H_eff | float(0),
          'dT_forecast_K': dT_forecast | float(0)
        },
        'temperatures': {
          'set_effective': t_set_eff | from_json(default={}),
          'current': t_now | from_json(default={}),
          'set_base': t_set_base | from_json(default={})
        },
        'errors': terr_map | from_json(default={}),
        'phases': phase_map | from_json(default={}),
        'currents_amps': amps_map | from_json(default={}),
        'needs_heating': need_map | from_json(default={}),
        'candidates': cand_list | from_json(default=[]),
        'selected': {
          'phase_1': sel_p1 | from_json(default=[]),
          'phase_2': sel_p2 | from_json(default=[]),
          'phase_3': sel_p3 | from_json(default=[]),
          'final': final_on | from_json(default=[])
        },
        'switches': {
          'on': sw_on | from_json(default=[]),
          'off': sw_off | from_json(default=[])
        }
      } %}
      {{ (debug_data | tojson) | string }}
  
  condition: []
  action:
    # ===================================================================
    # ACTION 1: Update temperature setpoints if offset is active
    # ===================================================================
    - choose:
        - conditions: "{{ offset_k | float(0) > 0 }}"
          sequence:
            - service: logbook.log
              data:
                name: "Heiz-Planer"
                message: "Offset aktiv: {{ offset_k | float(0) }}K (PV: {{ pv_offset_k | float(0) }}K, Preheat: {{ preheat_offset_k | float(0) }}K)"
            - repeat:
                for_each: "{{ rooms_json | from_json(default=[]) }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "climate.raum_{{ repeat.item }}"
                    data:
                      temperature: "{{ (t_set_eff | from_json(default={}))[repeat.item] | float }}"
    
    # ===================================================================
    # ACTION 2: Log comprehensive debug information
    # ===================================================================
    - service: logbook.log
      data:
        name: "Heiz-Planer"
        message: "{{ dbg }}"