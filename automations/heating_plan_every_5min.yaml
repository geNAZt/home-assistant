- id: heating_plan_every_5min
  alias: "Heizung: Planung alle 5 Minuten (PV/Preheat/Phasen)"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "/5"
  variables:
    # ===================================================================
    # SECTION 1: CONFIGURATION & GLOBAL PARAMETERS
    # ===================================================================
    rooms_json: '["bad","kueche","schlafzimmer","flur","speisekammer","wohnzimmer","buero_merja","buero_fabian"]'
    phase_max_amps: 16.0
    hysteresis_k: 0.05
    
    # PV and preheat parameters
    pv_forecast_w: "{{ states('sensor.solcast_pv_forecast_leistung_in_30_minuten') | float(0) }}"
    pv_thr_w: "{{ states('input_number.pv_excess_threshold_w') | float(0) }}"
    has_pv_excess: "{{ pv_forecast_w > pv_thr_w }}"
    pv_offset_k: "{{ 0.5 if has_pv_excess else 0 }}"
    
    is_preheat_window: >-
      {% set current_ts = as_timestamp(now()) %}
      {% set window_start = as_timestamp(now().replace(hour=0, minute=0, second=0, microsecond=0)) %}
      {% set window_end = as_timestamp(now().replace(hour=6, minute=0, second=0, microsecond=0)) %}
      {{ window_start <= current_ts < window_end }}
    
    # Heating blocking: When enabled, only allow heating during preheat window (00:00-06:00)
    # Turn this switch ON to block heating outside preheat window
    heating_block_enabled: "{{ is_state('input_boolean.heating_block_daytime', 'on') }}"
    
    # Check if heating should be blocked (blocking enabled AND outside preheat window)
    heating_blocked: "{{ heating_block_enabled and not is_preheat_window }}"
    
    C_eff: "{{ states('sensor.C_kWh_per_K_rolling') | float(10) }}"
    H_eff: "{{ states('sensor.H_kW_per_K_rolling_sql') | float(6.25) }}"
    dT_forecast: "{{ states('input_number.delta_t_forecast_k') | float(0) }}"
    
    preheat_offset_k: >-
      {% set heat_capacity = C_eff | float(0) %}
      {% set heating_power = H_eff | float(0) %}
      {% set temp_drop = dT_forecast | float(0) %}
      {% set energy_needed_kwh = heating_power * temp_drop %}
      {% set offset_raw = (energy_needed_kwh / heat_capacity) if heat_capacity > 0 else 0 %}
      {% if not is_preheat_window %}
        0
      {% else %}
        {% set offset_clamped_low = 0.2 if offset_raw < 0.2 else offset_raw %}
        {% set offset_clamped = 0.6 if offset_clamped_low > 0.6 else offset_clamped_low %}
        {{ offset_clamped }}
      {% endif %}
    
    offset_k: >-
      {% set preheat = preheat_offset_k | float(0) %}
      {% set pv = pv_offset_k | float(0) %}
      {% set total = preheat + pv %}
      {% if total < 0 %}
        0
      {% elif total > 0.6 %}
        0.6
      {% else %}
        {{ total }}
      {% endif %}
    
    # ===================================================================
    # SECTION 2: COMPREHENSIVE ROOM DATA (Single Pass)
    # ===================================================================
    # Build all room data in one pass - no JSON parsing needed!
    room_data: >-
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set offset = offset_k | float(0) %}
      {% set hyst = hysteresis_k | float(0.05) %}
      {% set invalid_states = ['unknown', 'unavailable', 'None', ''] %}
      {% set ns = namespace(rooms = {}) %}
      
      {% for room in rooms %}
        {% set climate_entity = 'climate.room_' ~ room %}
        {% set sensor_l1 = 'sensor.current_l1_' ~ room ~ '_current' %}
        {% set sensor_l2 = 'sensor.current_l2_' ~ room ~ '_current' %}
        {% set sensor_l3 = 'sensor.current_l3_' ~ room ~ '_current' %}
        
        {# Read temperatures #}
        {% set current_temp = state_attr(climate_entity, 'current_temperature') %}
        {% set current_setpoint = state_attr(climate_entity, 'temperature') %}
        
        {# Get base temperature from helper, or use current setpoint if helper doesn't exist #}
        {# This prevents offset accumulation by always using the original base temperature #}
        {% set base_helper = 'input_number.heating_base_' ~ room %}
        {% set stored_base = states(base_helper) | float(0) %}
        {% if stored_base > 0 %}
          {# Use stored base temperature (original, before any offsets) #}
          {% set base_target = stored_base %}
        {% elif current_setpoint is number %}
          {# No stored base yet, use current setpoint as base (will be stored when offset is first applied) #}
          {% set base_target = current_setpoint | float %}
        {% else %}
          {# Fallback default #}
          {% set base_target = 22.0 %}
        {% endif %}
        
        {% if current_temp is number %}
          {% set current = current_temp | float %}
        {% else %}
          {% set current = 22.0 %}
        {% endif %}
        
        {% set effective_target = base_target + offset %}
        {% set error = effective_target - current %}
        
        {# Determine phase #}
        {% set phase = 0 %}
        {% if states(sensor_l1) not in invalid_states %}
          {% set phase = 1 %}
        {% elif states(sensor_l2) not in invalid_states %}
          {% set phase = 2 %}
        {% elif states(sensor_l3) not in invalid_states %}
          {% set phase = 3 %}
        {% endif %}
        
        {# Get current consumption #}
        {% set live_current_ma = 0 %}
        {% if states(sensor_l1) not in invalid_states %}
          {% set live_current_ma = states(sensor_l1) | float(0) %}
        {% elif states(sensor_l2) not in invalid_states %}
          {% set live_current_ma = states(sensor_l2) | float(0) %}
        {% elif states(sensor_l3) not in invalid_states %}
          {% set live_current_ma = states(sensor_l3) | float(0) %}
        {% endif %}
        {% if live_current_ma > 0 %}
          {% set live_current_a = live_current_ma / 1000 %}
        {% else %}
          {% set live_current_a = 0 %}
        {% endif %}
        {% set sql_current_a = states('sensor.heater_' ~ room ~ '_max_current_a') | float(0) %}
        {% set rated_current_a = states('input_number.heater_' ~ room ~ '_rated_a') | float(0) %}
        {% if live_current_a > 0 %}
          {% set amps = live_current_a %}
        {% elif sql_current_a > 0 %}
          {% set amps = sql_current_a %}
        {% else %}
          {% set amps = rated_current_a %}
        {% endif %}
        
        {# Determine if heating is needed #}
        {% set threshold = effective_target - hyst %}
        {% set needs_heating = current < threshold %}
        
        {# Build room data structure #}
        {% set ns.rooms = ns.rooms | combine({ 
          room: {
            'entity': climate_entity,
            'current_temp': current,
            'base_target': base_target,
            'effective_target': effective_target,
            'error': error,
            'phase': phase,
            'amps': amps,
            'needs_heating': needs_heating
          }
        }) %}
      {% endfor %}
      {{ (ns.rooms | tojson) | string }}
    
    # ===================================================================
    # SECTION 3: ROOM SELECTION BY PHASE
    # ===================================================================
    # Select rooms for each phase using greedy algorithm
    sel_p1: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(room_list = [], selected = []) %}
      {% for room in all_rooms %}
        {% if rooms_data[room] is defined %}
          {% set data = rooms_data[room] %}
          {% if data.phase == 1 and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
      {% set total = 0.0 %}
      {% set max_amps_float = max_amps | float(16.0) %}
      {% for item in sorted %}
        {% set item_amps = item.amps | float(0) %}
        {% set new_total = total + item_amps %}
        {% if new_total <= max_amps_float %}
          {% set total = new_total %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    sel_p2: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(room_list = [], selected = []) %}
      {% for room in all_rooms %}
        {% if rooms_data[room] is defined %}
          {% set data = rooms_data[room] %}
          {% if data.phase == 2 and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
      {% set total = 0.0 %}
      {% set max_amps_float = max_amps | float(16.0) %}
      {% for item in sorted %}
        {% set item_amps = item.amps | float(0) %}
        {% set new_total = total + item_amps %}
        {% if new_total <= max_amps_float %}
          {% set total = new_total %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    sel_p3: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(room_list = [], selected = []) %}
      {% for room in all_rooms %}
        {% if rooms_data[room] is defined %}
          {% set data = rooms_data[room] %}
          {% if data.phase == 3 and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
      {% set total = 0.0 %}
      {% set max_amps_float = max_amps | float(16.0) %}
      {% for item in sorted %}
        {% set item_amps = item.amps | float(0) %}
        {% set new_total = total + item_amps %}
        {% if new_total <= max_amps_float %}
          {% set total = new_total %}
          {% set ns.selected = ns.selected + [item.room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.selected | tojson) | string }}
    
    final_on: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(final = []) %}
      {% for phase_num in [1, 2, 3] %}
        {% set ns.room_list = [] %}
        {% for room in all_rooms %}
          {% if rooms_data[room] is defined %}
            {% set data = rooms_data[room] %}
            {% if data.phase == phase_num and data.needs_heating %}
              {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
        {% set total = 0.0 %}
        {% for item in sorted %}
          {% if total + item.amps <= max_amps %}
            {% set total = total + item.amps %}
            {% if item.room not in ns.final %}
              {% set ns.final = ns.final + [item.room] %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {{ (ns.final | tojson) | string }}
    
    # ===================================================================
    # SECTION 4: CLIMATE ENTITY MAPPING (for debug output)
    # ===================================================================
    climates_on: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set ns = namespace(selected_rooms = [], climates = []) %}
      {% for phase_num in [1, 2, 3] %}
        {% set ns.room_list = [] %}
        {% for room, data in rooms_data.items() %}
          {% if data.phase == phase_num and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endfor %}
        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
        {% set total = 0.0 %}
        {% for item in sorted %}
          {% if total + item.amps <= max_amps %}
            {% set total = total + item.amps %}
            {% if item.room not in ns.selected_rooms %}
              {% set ns.selected_rooms = ns.selected_rooms + [item.room] %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {% for room in ns.selected_rooms %}
        {% set ns.climates = ns.climates + ['climate.room_' ~ room] %}
      {% endfor %}
      {{ (ns.climates | tojson) | string }}
    
    climates_off: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% set all_rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(selected_rooms = [], climates = []) %}
      {% for phase_num in [1, 2, 3] %}
        {% set ns.room_list = [] %}
        {% for room, data in rooms_data.items() %}
          {% if data.phase == phase_num and data.needs_heating %}
            {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
          {% endif %}
        {% endfor %}
        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
        {% set total = 0.0 %}
        {% for item in sorted %}
          {% if total + item.amps <= max_amps %}
            {% set total = total + item.amps %}
            {% if item.room not in ns.selected_rooms %}
              {% set ns.selected_rooms = ns.selected_rooms + [item.room] %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endfor %}
      {% for room in all_rooms %}
        {% if room not in ns.selected_rooms %}
          {% set ns.climates = ns.climates + ['climate.room_' ~ room] %}
        {% endif %}
      {% endfor %}
      {{ (ns.climates | tojson) | string }}
    
    # ===================================================================
    # SECTION 5: DEBUG OUTPUT
    # ===================================================================
    dbg: >-
      {% set rooms_data = room_data | from_json(default={}) %}
      {% set rooms = rooms_json | from_json(default=[]) %}
      {% set ns = namespace(candidates = [], sel_p1_list = [], sel_p2_list = [], sel_p3_list = []) %}
      
      {# Build candidates list #}
      {% for room in rooms %}
        {% if rooms_data[room] is defined and rooms_data[room].needs_heating %}
          {% set ns.candidates = ns.candidates + [room] %}
        {% endif %}
      {% endfor %}
      
      {# Build selections (same logic as sel_p1/2/3 but inline) #}
      {% set max_amps = phase_max_amps | float(16.0) %}
      {% for phase_num in [1, 2, 3] %}
        {% set ns.room_list = [] %}
        {% for room in rooms %}
          {% if rooms_data[room] is defined %}
            {% set data = rooms_data[room] %}
            {% if data.phase == phase_num and data.needs_heating %}
              {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
        {% if phase_num == 1 %}
          {% set ns.sel_p1_list = [] %}
          {% set total = 0.0 %}
          {% for item in sorted %}
            {% if total + item.amps <= max_amps %}
              {% set total = total + item.amps %}
              {% set ns.sel_p1_list = ns.sel_p1_list + [item.room] %}
            {% endif %}
          {% endfor %}
        {% elif phase_num == 2 %}
          {% set ns.sel_p2_list = [] %}
          {% set total = 0.0 %}
          {% for item in sorted %}
            {% if total + item.amps <= max_amps %}
              {% set total = total + item.amps %}
              {% set ns.sel_p2_list = ns.sel_p2_list + [item.room] %}
            {% endif %}
          {% endfor %}
        {% elif phase_num == 3 %}
          {% set ns.sel_p3_list = [] %}
          {% set total = 0.0 %}
          {% for item in sorted %}
            {% if total + item.amps <= max_amps %}
              {% set total = total + item.amps %}
              {% set ns.sel_p3_list = ns.sel_p3_list + [item.room] %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
      
      {% set ns.temps_current = {} %}
      {% set ns.temps_base = {} %}
      {% set ns.temps_eff = {} %}
      {% set ns.errors_dict = {} %}
      {% set ns.phases_dict = {} %}
      {% set ns.amps_dict = {} %}
      {% set ns.needs_dict = {} %}
      {% set ns.selected_rooms_debug = [] %}
      {% for room in rooms %}
        {% if rooms_data[room] is defined %}
          {% set data = rooms_data[room] %}
          {% set temp_dict_current = {room: data.current_temp} %}
          {% set temp_dict_base = {room: data.base_target} %}
          {% set temp_dict_eff = {room: data.effective_target} %}
          {% set temp_dict_error = {room: data.error} %}
          {% set temp_dict_phase = {room: data.phase} %}
          {% set temp_dict_amps = {room: data.amps} %}
          {% set temp_dict_needs = {room: data.needs_heating} %}
          {% set ns.temps_current = ns.temps_current | combine(temp_dict_current) %}
          {% set ns.temps_base = ns.temps_base | combine(temp_dict_base) %}
          {% set ns.temps_eff = ns.temps_eff | combine(temp_dict_eff) %}
          {% set ns.errors_dict = ns.errors_dict | combine(temp_dict_error) %}
          {% set ns.phases_dict = ns.phases_dict | combine(temp_dict_phase) %}
          {% set ns.amps_dict = ns.amps_dict | combine(temp_dict_amps) %}
          {% set ns.needs_dict = ns.needs_dict | combine(temp_dict_needs) %}
        {% endif %}
      {% endfor %}
      
      {# Build selected rooms list from phase selections #}
      {% set all_selected = ns.sel_p1_list + ns.sel_p2_list + ns.sel_p3_list %}
      {% for room in all_selected %}
        {% if room not in ns.selected_rooms_debug %}
          {% set ns.selected_rooms_debug = ns.selected_rooms_debug + [room] %}
        {% endif %}
      {% endfor %}
      
      {# Build climate entity lists #}
      {% set ns.climates_on_list = [] %}
      {% set ns.climates_off_list = [] %}
      {% for room in ns.selected_rooms_debug %}
        {% set ns.climates_on_list = ns.climates_on_list + ['climate.room_' ~ room] %}
      {% endfor %}
      {% for room in rooms %}
        {% if room not in ns.selected_rooms_debug %}
          {% set ns.climates_off_list = ns.climates_off_list + ['climate.room_' ~ room] %}
        {% endif %}
      {% endfor %}
      
      {% set debug_data = {
        'timestamp': now().isoformat(),
        'offsets': {
          'total_k': offset_k | float(0),
          'preheat_k': preheat_offset_k | float(0),
          'pv_k': pv_offset_k | float(0)
        },
        'pv': {
          'forecast_w': pv_forecast_w | float(0),
          'threshold_w': pv_thr_w | float(0),
          'has_excess': has_pv_excess
        },
        'preheat': {
          'is_window': is_preheat_window,
          'window_active': is_preheat_window,
          'block_enabled': heating_block_enabled,
          'heating_blocked': heating_blocked
        },
        'thermal': {
          'C_eff_kWh_per_K': C_eff | float(0),
          'H_eff_kW_per_K': H_eff | float(0),
          'dT_forecast_K': dT_forecast | float(0)
        },
        'temperatures': {
          'current': ns.temps_current,
          'set_base': ns.temps_base,
          'set_effective': ns.temps_eff
        },
        'errors': ns.errors_dict,
        'phases': ns.phases_dict,
        'currents_amps': ns.amps_dict,
        'needs_heating': ns.needs_dict,
        'candidates': ns.candidates,
        'selected': {
          'phase_1': ns.sel_p1_list,
          'phase_2': ns.sel_p2_list,
          'phase_3': ns.sel_p3_list,
          'final': (ns.sel_p1_list + ns.sel_p2_list + ns.sel_p3_list) | unique | list
        },
        'climates': {
          'heat': ns.climates_on_list,
          'off': ns.climates_off_list
        }
      } %}
      {{ (debug_data | tojson) | string }}
  
  condition: []
  action:
    # ===================================================================
    # ACTION 1: Update temperature setpoints based on offset
    # ===================================================================
    # Store base temperatures and apply/reset offsets
    - repeat:
        for_each: "{{ rooms_json | from_json(default=[]) }}"
        sequence:
          - choose:
              # If offset is active: Store base temp (if not stored) and apply offset
              - conditions:
                  - condition: template
                    value_template: "{{ offset_k | float(0) > 0 }}"
                sequence:
                  - service: input_number.set_value
                    target:
                      entity_id: "input_number.heating_base_{{ repeat.item }}"
                    data:
                      value: >-
                        {% set base_helper = 'input_number.heating_base_' ~ repeat.item %}
                        {% set stored_base = states(base_helper) | float(0) %}
                        {% set rooms_data = room_data | from_json(default={}) %}
                        {% if stored_base > 0 %}
                          {# Keep existing stored base #}
                          {{ stored_base }}
                        {% else %}
                          {# Store current setpoint as base (before offset is applied) #}
                          {{ rooms_data[repeat.item].base_target | float }}
                        {% endif %}
                  - service: climate.set_temperature
                    target:
                      entity_id: "climate.room_{{ repeat.item }}"
                    data:
                      temperature: >-
                        {% set base_helper = 'input_number.heating_base_' ~ repeat.item %}
                        {% set stored_base = states(base_helper) | float(0) %}
                        {% set offset = offset_k | float(0) %}
                        {% if stored_base > 0 %}
                          {# Use stored base + offset #}
                          {{ stored_base + offset }}
                        {% else %}
                          {# Fallback: use calculated effective target #}
                          {% set rooms_data = room_data | from_json(default={}) %}
                          {{ rooms_data[repeat.item].effective_target | float }}
                        {% endif %}
              # If offset is 0: Reset to stored base temperature (if stored)
              - conditions:
                  - condition: template
                    value_template: "{{ offset_k | float(0) == 0 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "climate.room_{{ repeat.item }}"
                    data:
                      temperature: >-
                        {% set base_helper = 'input_number.heating_base_' ~ repeat.item %}
                        {% set stored_base = states(base_helper) | float(0) %}
                        {% if stored_base > 0 %}
                          {# Reset to stored base #}
                          {{ stored_base }}
                        {% else %}
                          {# No stored base: use current setpoint (don't change) #}
                          {% set rooms_data = room_data | from_json(default={}) %}
                          {{ rooms_data[repeat.item].base_target | float }}
                        {% endif %}
    # Log offset status
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ offset_k | float(0) > 0 }}"
          sequence:
            - service: logbook.log
              data:
                name: "Heiz-Planer"
                message: "Offset aktiv: {{ offset_k | float(0) }}K (PV: {{ pv_offset_k | float(0) }}K, Preheat: {{ preheat_offset_k | float(0) }}K)"
    
    # ===================================================================
    # ACTION 2: Log debug information
    # ===================================================================
    - service: logbook.log
      data:
        name: "Heiz-Planer"
        message: "{{ dbg }}"
    
    # ===================================================================
    # ACTION 3: Control heating climate modes
    # ===================================================================
    - choose:
        # If heating is blocked (blocking enabled AND outside preheat window), set all climates to OFF
        - conditions:
            - condition: template
              value_template: "{{ heating_blocked }}"
          sequence:
            - service: logbook.log
              data:
                name: "Heiz-Planer"
                message: "Heizung blockiert (nur Preheating erlaubt): Alle KlimagerÃ¤te AUS"
            - service: climate.set_hvac_mode
              target:
                entity_id: >-
                  {% set all_rooms = rooms_json | from_json(default=[]) %}
                  {% set climates = [] %}
                  {% for room in all_rooms %}
                    {% set climates = climates + ['climate.room_' ~ room] %}
                  {% endfor %}
                  {{ climates }}
              data:
                hvac_mode: "off"
        # Normal operation: Select rooms based on phase and temperature
        - conditions: []
          sequence:
            - parallel:
                # Set HVAC mode to "heat" for selected rooms
                - service: climate.set_hvac_mode
                  target:
                    entity_id: >-
                      {% set rooms_data = room_data | from_json(default={}) %}
                      {% set max_amps = phase_max_amps | float(16.0) %}
                      {% set all_rooms = rooms_json | from_json(default=[]) %}
                      {% set ns = namespace(selected_rooms = [], climates = []) %}
                      {% for phase_num in [1, 2, 3] %}
                        {% set ns.room_list = [] %}
                        {% for room in all_rooms %}
                          {% if rooms_data[room] is defined %}
                            {% set data = rooms_data[room] %}
                            {% if data.phase == phase_num and data.needs_heating %}
                              {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
                        {% set total = 0.0 %}
                        {% set max_amps_float = max_amps | float(16.0) %}
                        {% for item in sorted %}
                          {% set item_amps = item.amps | float(0) %}
                          {% set new_total = total + item_amps %}
                          {% if new_total <= max_amps_float %}
                            {% set total = new_total %}
                            {% if item.room not in ns.selected_rooms %}
                              {% set ns.selected_rooms = ns.selected_rooms + [item.room] %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      {% endfor %}
                      {% for room in ns.selected_rooms %}
                        {% set ns.climates = ns.climates + ['climate.room_' ~ room] %}
                      {% endfor %}
                      {{ ns.climates }}
                  data:
                    hvac_mode: "heat"
                # Set HVAC mode to "off" for non-selected rooms
                - service: climate.set_hvac_mode
                  target:
                    entity_id: >-
                      {% set rooms_data = room_data | from_json(default={}) %}
                      {% set max_amps = phase_max_amps | float(16.0) %}
                      {% set all_rooms = rooms_json | from_json(default=[]) %}
                      {% set ns = namespace(selected_rooms = [], climates = []) %}
                      {% for phase_num in [1, 2, 3] %}
                        {% set ns.room_list = [] %}
                        {% for room in all_rooms %}
                          {% if rooms_data[room] is defined %}
                            {% set data = rooms_data[room] %}
                            {% if data.phase == phase_num and data.needs_heating %}
                              {% set ns.room_list = ns.room_list + [{'room': room, 'error': data.error, 'amps': data.amps}] %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                        {% set sorted = ns.room_list | sort(attribute='error', reverse=True) %}
                        {% set total = 0.0 %}
                        {% set max_amps_float = max_amps | float(16.0) %}
                        {% for item in sorted %}
                          {% set item_amps = item.amps | float(0) %}
                          {% set new_total = total + item_amps %}
                          {% if new_total <= max_amps_float %}
                            {% set total = new_total %}
                            {% if item.room not in ns.selected_rooms %}
                              {% set ns.selected_rooms = ns.selected_rooms + [item.room] %}
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      {% endfor %}
                      {% for room in all_rooms %}
                        {% if room not in ns.selected_rooms %}
                          {% set ns.climates = ns.climates + ['climate.room_' ~ room] %}
                        {% endif %}
                      {% endfor %}
                      {{ ns.climates }}
                  data:
                    hvac_mode: "off"
