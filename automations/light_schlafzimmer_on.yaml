- alias: schlafzimmer licht automatisch AN
  id: auto_light_schlafzimmer_on
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.presence_schlafzimmer
      to: "on"
    - platform: numeric_state
      entity_id: sensor.lux_schlafzimmer
      below: 120          # waterLowLux
      for: "00:00:05"
    - platform: state
      entity_id: input_boolean.auto_light_schlafzimmer
      state: "on"

  condition:
    # Automatik muss an sein
    - condition: state
      entity_id: input_boolean.auto_light_schlafzimmer
      state: "on"

    # PrÃ¤senz notwendig
    - condition: state
      entity_id: binary_sensor.presence_schlafzimmer
      state: "on"

    # Lux muss UNTER 120 sein
    - condition: numeric_state
      entity_id: sensor.lux_schlafzimmer
      below: 120

    # Licht nur einschalten, wenn es wirklich aus ist
    - condition: state
      entity_id: light.schlafzimmer_lights
      state: "off"

    # Optional: wenn ForceOn vorhanden, diese Automation deaktivieren
    # indem ForceOn "off" sein muss
    - condition: or
      conditions:
        - condition: template
          value_template: "{{ not states('input_boolean.force_on_schlafzimmer') }}"
        - condition: state
          entity_id: input_boolean.force_on_schlafzimmer
          state: "off"

  action:
    - variables:
        saved_brightness: "{{ states('input_number.schlafzimmer_brightness') | int(0) }}"
        brightness: >
          {{ 300 if saved_brightness == 0 else saved_brightness }}
        color_temp: "{{ states('input_number.schlafzimmer_color_temp') | int(370) }}"
    - service: light.turn_on
      target:
        entity_id: light.schlafzimmer_lights
      data:
        brightness: "{{ brightness }}"
        color_temp: "{{ color_temp }}"
