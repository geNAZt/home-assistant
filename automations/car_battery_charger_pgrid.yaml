- id: car_battery_charger_pgrid
  alias: Car Battery Charger PGrid Update
  description: Updates car charger pgrid value every 2 seconds based on PV excess power availability
  mode: restart
  trigger:
    - platform: time_pattern
      seconds: "/2"
  variables:
    # Current state
    exported_power: "{{ states('sensor.filtered_exported_power_w') | float(0) }}"
    charger_usage: "{{ states('sensor.goe_288025_nrg_11') | float(0) }}"
    
    # Calculate pgrid value
    pgrid_value: >-
      {% set exp = exported_power | float(0) %}
      {% set usage = charger_usage | float(0) %}
      {% set threshold = 1600 %}
      
      {% if exp > threshold %}
        {# Exported power above 1.6kW - set pgrid to exported_power * -1 #}
        {{ exp * -1 }}
      {% elif usage == 0 %}
        {# Charger is off and exported power below threshold - set pgrid to 0 #}
        0
      {% else %}
        {# Exported power below threshold and charger is on - force stop #}
        10500
      {% endif %}
  
  condition: []
  action:
    - service: goecharger_api2.set_pv_data
      data:
        pgrid: "{{ pgrid_value }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ exported_power > 1600 }}"
          sequence:
            - service: logbook.log
              data:
                name: Car Battery Charger
                message: "Exported power ({{ exported_power | round(2) }} W) above 1.6kW, setting pgrid to {{ pgrid_value | round(2) }} W"
        - conditions:
            - condition: template
              value_template: "{{ exported_power <= 1600 and charger_usage == 0 }}"
          sequence:
            - service: logbook.log
              data:
                name: Car Battery Charger
                message: "Exported power ({{ exported_power | round(2) }} W) below 1.6kW and charger off, setting pgrid to 0"
        - conditions:
            - condition: template
              value_template: "{{ exported_power <= 1600 and charger_usage > 0 }}"
          sequence:
            - service: logbook.log
              data:
                name: Car Battery Charger
                message: "Exported power ({{ exported_power | round(2) }} W) below 1.6kW, forcing stop (pgrid=10500)"
      default: []

