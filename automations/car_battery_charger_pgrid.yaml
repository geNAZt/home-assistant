- id: car_battery_charger_pgrid
  alias: Car Battery Charger PGrid Update
  description: Updates car charger pgrid value every 2 seconds based on PV excess power availability
  mode: restart
  trigger:
    - platform: time_pattern
      seconds: "/5" # The charger forgets after 5 seconds
  condition:
  - condition: and
    conditions:
    - condition: template
      value_template: "{{ states('binary_sensor.goe_288025_car_0') == 'on' }}"
    - condition: template 
      value_template: "{{ states('sensor.filtered_exported_power_w') | float(0) > 1600 }}"
  variables:
    # Current state
    exported_power: "{{ states('sensor.filtered_exported_power_w') | float(0) }}"
    
    # Calculate pgrid value
    pgrid_value: >-
      {% set exp = exported_power | float(0) %}    
      {{ exp * -1 }}
  action:
    - service: goecharger_api2.set_pv_data
      data:
        pgrid: "{{ pgrid_value }}"
    