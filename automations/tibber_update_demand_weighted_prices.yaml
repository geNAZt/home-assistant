- id: tibber_update_demand_weighted_prices
  alias: "Heizung: Bedarf-gewichtete Tibber Ø Preise (00–06, 06–24)"
  mode: single
  trigger:
    - platform: time_pattern
      minutes: "0"
    - platform: homeassistant
      event: start

  action:
    # --- Plan-Tag festlegen: heute wenn <06:00, sonst morgen ---
    - variables:
        base: >-
          {% set b = now().replace(hour=0, minute=0, second=0, microsecond=0) %}
          {% if now().hour >= 6 %}
            {% set b = b + timedelta(days=1) %}
          {% endif %}
          {{ b }}
        t00: "{{ as_timestamp(base) }}"
        t06: "{{ as_timestamp(base.replace(hour=6, minute=0, second=0, microsecond=0)) }}"
        t24: "{{ as_timestamp(base + timedelta(days=1)) }}"

    # --- 1) Wetter-Forecast holen (hourly) ---
    - service: weather.get_forecasts
      data:
        type: hourly
        entity_id: weather.home
      response_variable: wx_resp

    # --- 2) Tibber-Preise für genau diesen Plan-Tag holen (00:00..24:00) ---
    - service: tibber.get_prices
      data:
        start: "{{ base.strftime('%Y-%m-%d %H:%M:%S') }}"
        end: "{{ (base + timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S') }}"
      response_variable: tibber_resp

    - variables:
        # -------- Preise extrahieren (Array) --------
        prices_arr: >-
          {% set raw = tibber_resp %}
          {% set arr = [] %}
          {% if raw is mapping and 'prices' in raw and (raw['prices'] is mapping) %}
            {% set first_key = (raw['prices'].keys() | list | first) %}
            {% if first_key %}{% set arr = raw['prices'][first_key] %}{% endif %}
          {% elif raw is sequence %}
            {% set arr = raw %}
          {% endif %}
          {{ arr if arr is sequence else [] }}

        # -------- Forecast extrahieren (Array) --------
        # weather.get_forecasts liefert typischerweise:
        # wx_resp = { "weather.home": { "forecast": [ {datetime, temperature, ...}, ...] } }
        forecast_arr: >-
          {% set raw = wx_resp %}
          {% set out = [] %}
          {% if raw is mapping %}
            {% set e = raw.get('weather.home') %}
            {% if e is mapping and e.get('forecast') is iterable %}
              {% set out = e.get('forecast') %}
            {% elif raw.get('forecast') is iterable %}
              {% set out = raw.get('forecast') %}
            {% endif %}
          {% endif %}
          {{ out if out is iterable else [] }}

        # -------- wx_map bauen: hour_ts -> outside_temp --------
        wx_map: >-
          {% set ns = namespace(m={}) %}
          {% for p in forecast_arr %}
            {% set dt = p.datetime if p.datetime is defined else (p.datetime_iso if p.datetime_iso is defined else none) %}
            {% set t  = p.temperature if p.temperature is defined else none %}
            {% if dt is not none and t is not none %}
              {% set ts = as_timestamp(dt) %}
              {% if ts is number %}
                {% set hour = (ts - (ts % 3600)) | int %}
                {% set ns.m = ns.m | combine({ hour: (t|float(0)) }) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ ns.m }}

        Tbase: "{{ states('input_number.preheat_base_indoor_c')|float(21.5) }}"
        Tout_fallback: "{{ states('sensor.outside_temperature')|float(0) }}"

        # -------- Demand-weighted Ø Preis 00–06 --------
        dw_00_06: >-
          {% set ns = namespace(num=0.0, den=0.0) %}
          {% for p in prices_arr %}
            {% set dt = p.start_time if p.start_time is defined else (p.startsAt if p.startsAt is defined else none) %}
            {% set pr = p.price if p.price is defined else (p.total if p.total is defined else none) %}
            {% if dt is not none and pr is not none %}
              {% set ts = as_timestamp(dt) %}
              {% if ts is number and (t00 <= ts < t06) %}
                {% set hour = (ts - (ts % 3600)) | int %}
                {% set Tout = wx_map[hour] if wx_map[hour] is defined else Tout_fallback %}
                {% set w = (Tbase - (Tout|float(0))) %}
                {% if w < 0 %}{% set w = 0 %}{% endif %}
                {% set ns.num = ns.num + (pr|float(0)) * w %}
                {% set ns.den = ns.den + w %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ (ns.num / ns.den) if ns.den>0 else 0 }}

        # -------- Demand-weighted Ø Preis 06–24 --------
        dw_06_24: >-
          {% set ns = namespace(num=0.0, den=0.0) %}
          {% for p in prices_arr %}
            {% set dt = p.start_time if p.start_time is defined else (p.startsAt if p.startsAt is defined else none) %}
            {% set pr = p.price if p.price is defined else (p.total if p.total is defined else none) %}
            {% if dt is not none and pr is not none %}
              {% set ts = as_timestamp(dt) %}
              {% if ts is number and (t06 <= ts < t24) %}
                {% set hour = (ts - (ts % 3600)) | int %}
                {% set Tout = wx_map[hour] if wx_map[hour] is defined else Tout_fallback %}
                {% set w = (Tbase - (Tout|float(0))) %}
                {% if w < 0 %}{% set w = 0 %}{% endif %}
                {% set ns.num = ns.num + (pr|float(0)) * w %}
                {% set ns.den = ns.den + w %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ (ns.num / ns.den) if ns.den>0 else 0 }}

    - service: input_number.set_value
      target: { entity_id: input_number.tibber_price_dw_00_06 }
      data: { value: "{{ dw_00_06|float(0) }}" }

    - service: input_number.set_value
      target: { entity_id: input_number.tibber_price_dw_06_24 }
      data: { value: "{{ dw_06_24|float(0) }}" }