- id: heating_persist_manual_setpoint
  alias: "Heizung: Persist manual setpoint to base"
  mode: queued
  trigger:
    - platform: state
      entity_id:
        - climate.climate_room_bad
        - climate.climate_room_wohnzimmer
        - climate.climate_room_kueche
        - climate.climate_room_schlafzimmer
        - climate.climate_room_flur
        - climate.climate_room_speisekammer
        - climate.climate_room_buero_merja
        - climate.climate_room_buero_fabian
      attribute: temperature

  condition:
    - condition: state
      entity_id: input_boolean.heating_planner_applying
      state: "off"

  action:
    - variables:
        room: "{{ trigger.entity_id | regex_replace('^climate\\.climate_room_', '') }}"
        base_ent: "{{ 'input_number.heating_base_' ~ room }}"
        off_ent: "{{ 'input_number.heating_offset_' ~ room }}"
        new_sp: "{{ trigger.to_state.attributes.temperature | float(0) }}"
        offset_k: "{{ states(off_ent) | float(0) }}"
        new_base: "{{ (new_sp - offset_k) | round(1) }}"
        eps: 0.06

        changed: >-
          {% set old = trigger.from_state.attributes.temperature | float(0) %}
          {{ new_sp > 0 and (new_sp - old) | abs > eps }}

    - choose:
        - conditions:
            - condition: template
              value_template: "{{ changed }}"
          sequence:
            - service: input_number.set_value
              target: { entity_id: "{{ base_ent }}" }
              data: { value: "{{ new_base }}" }

            - service: logbook.log
              data:
                name: "Heiz-Planer"
                message: >-
                  Manual SP persisted {{ room }}: sp={{ new_sp }}, off={{ offset_k }}, base={{ new_base }}
    - service: input_boolean.turn_on
      target: { entity_id: input_boolean.debt_reset_on_setpoint_hit }