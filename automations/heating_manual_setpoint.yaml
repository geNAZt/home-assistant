- id: heating_persist_manual_setpoint
  alias: "Heizung: Persist manual setpoint to base"
  mode: queued
  trigger:
    - platform: state
      entity_id:
        - climate.climate_room_bad
        - climate.climate_room_wohnzimmer
        - climate.climate_room_kueche
        - climate.climate_room_schlafzimmer
        - climate.climate_room_flur
        - climate.climate_room_speisekammer
        - climate.climate_room_buero_merja
        - climate.climate_room_buero_fabian
      attribute: temperature

  condition:
    - condition: state
      entity_id: input_boolean.heating_planner_applying
      state: "off"

  action:
    - variables:
        room: "{{ trigger.entity_id | regex_replace('^climate\\.climate_room_', '') }}"
        base_ent: "{{ 'input_number.heating_base_' ~ room }}"
        off_ent: "{{ 'input_number.heating_offset_' ~ room }}"

        new_sp: >-
          {{ trigger.to_state.attributes.temperature
             if trigger.to_state is not none and trigger.to_state.attributes.temperature is number
             else none }}

        old_sp: >-
          {{ trigger.from_state.attributes.temperature
             if trigger.from_state is not none and trigger.from_state.attributes.temperature is number
             else none }}

        off: "{{ states(off_ent) | float(0) }}"
        eps: 0.06

        changed: >-
          {% if new_sp is number and old_sp is number %}
            {{ (new_sp - old_sp) | abs > eps }}
          {% elif new_sp is number and old_sp is not number %}
            true
          {% else %}
            false
          {% endif %}

        new_base: >-
          {% if new_sp is number %}
            {{ (new_sp - off) | round(1) }}
          {% else %}
            {{ none }}
          {% endif %}

    - choose:
        - conditions:
            - condition: template
              value_template: "{{ changed and new_base is number }}"
          sequence:
            - service: input_number.set_value
              target: { entity_id: "{{ base_ent }}" }
              data: { value: "{{ new_base }}" }

            - service: logbook.log
              data:
                name: "Heiz-Planer"
                message: >-
                  Manual SP persisted {{ room }}: sp={{ new_sp }}, off={{ off }}, base={{ new_base }}
