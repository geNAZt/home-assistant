- id: heater_[[ room ]]_max_current_ma_update
  alias: "Update [[ room ]] Max Current record"
  mode: single
  trigger:
    - platform: state
      entity_id:
        - sensor.current_l1_[[ room ]]_current
        - sensor.current_l2_[[ room ]]_current
        - sensor.current_l3_[[ room ]]_current
  # Only act on real numbers (ignore unavailable/unknown)
  condition:
    - condition: template
      value_template: "{{ (trigger.to_state.state | float(0)) > 0 }}"
  action:
    - variables:
        new_val: "{{ trigger.to_state.state | float(0) }}"
        old_max: "{{ states('input_number.heater_[[ room ]]_rated_a') | float(0) * 1000 }}"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ new_val > old_max }}"
          sequence:
            - service: input_number.set_value
              target:
                entity_id: input_number.heater_[[ room ]]_rated_a
              data:
                value: "{{ new_val / 1000 | round(2) }}"
