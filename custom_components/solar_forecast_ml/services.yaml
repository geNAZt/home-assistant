# ============================================================================
# Solar Forecast ML Integration - Service Definitions
# ============================================================================
#
# âš ï¸âš ï¸âš ï¸ WICHTIGE WARNUNG / IMPORTANT WARNING âš ï¸âš ï¸âš ï¸
#
# Diese Services sind NUR fÃ¼r erfahrene Benutzer und Entwickler gedacht!
# These services are intended for EXPERIENCED USERS and DEVELOPERS ONLY!
#
# âŒ RISIKEN / RISKS:
#    - Datenverlust (ML-Modelle, Trainingsdaten, Konfigurationen)
#    - SysteminstabilitÃ¤t durch fehlerhafte Konfiguration
#    - BeschÃ¤digung der Integration, die Neuinstallation erfordert
#    - Unerwartete Ã„nderungen an Home Assistant Einstellungen
#
# âœ… EMPFEHLUNG / RECOMMENDATION:
#    - NUR ausfÃ¼hren wenn vom Support/Entwickler angewiesen
#    - IMMER vorher Backup erstellen (HA Snapshot)
#    - Bei Unsicherheit: NICHT ausfÃ¼hren!
#
# ğŸ”§ SUPPORT: github.com/your-repo/solar_forecast_ml/issues
#
# ============================================================================
# Service categories:
# - ML Services: Model training and management
# - Emergency Services: Manual day-end task execution
# - Testing Services: Essential testing and simulation
# - Astronomy Services: Solar calculations and cache management
# - Weather Services: Weather data management
# - Battery Services: Battery sensor discovery and configuration
# ============================================================================

# ============================================================================
# AI SERVICES - TinyLSTM Neural Network Model Management
# âš ï¸ DEVELOPER ONLY - Diese Services kÃ¶nnen das AI-System beschÃ¤digen!
# ============================================================================

retrain_ai_model:
  name: "ğŸ§  Retrain TinyLSTM AI Model"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ§  TinyLSTM NEURAL NETWORK TRAINING

    Forces immediate retraining of the TinyLSTM AI model with current data.

    Training requirements:
    - Minimum 50 training samples required
    - Uses last 30 days of data from hourly_predictions database table
    - Multi-Output mode: One output per panel group

    Data sources:
    - hourly_predictions database table (main source with actual production)
    - weather_forecast database table (weather + precision corrections)
    - astronomy_cache database table (sun position, theoretical max, clear-sky radiation)

    Model storage:
    - Weights: ai_model_weights database table (TinyLSTM weights)
    - Seasonal factors: ai_seasonal_factors database table
    - DNI tracking: ai_dni_tracker database table

    Use this service:
    - After collecting new production data (to improve accuracy)
    - After fixing solar_capacity configuration
    - If automatic training (06:00 daily) failed
  fields: {}

reset_ai_model:
  name: "âš ï¸ Reset TinyLSTM AI Model"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ ğŸš¨ GEFÃ„HRLICH / DANGEROUS - NUR FÃœR ENTWICKLER / DEVELOPER ONLY         â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•‘ ALLE gelernten Daten werden UNWIDERRUFLICH gelÃ¶scht!                    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    âš ï¸ DESTRUCTIVE ACTION - Resets AI model to untrained state!

    Resets the TinyLSTM AI model to its initial untrained state.

    What this service does:
    - Reinitializes the TinyLSTM model
    - Clears accuracy metrics and training sample count
    - Sets model state to UNTRAINED
    - Forces model to retrain from scratch on next training cycle

    Use this service:
    - After major configuration changes (solar_capacity, location)
    - If model produces consistently wrong predictions
    - To start fresh AI training
    - After corrupted ai_model_weights database table

    What happens after reset:
    - Model will use Rule-Based predictions until retrained
    - Next training (06:00 or manual) will rebuild from scratch
    - All historical prediction accuracy data is lost
    - Requires â‰¥50 samples with actual production to retrain

    âš ï¸ CAUTION: This action CANNOT be undone!
    Consider backing up the ai_model_weights database table before resetting.

    Alternative: Use retrain_ai_model service to keep model but retrain with latest data.
  fields: {}

analyze_feature_importance:
  name: "ğŸ“Š Analyze Feature Importance (DEVELOPER ONLY)"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ ğŸš¨ NUR FÃœR ENTWICKLER ODER AUF ANWEISUNG / DEVELOPER ONLY               â•‘
    â•‘ Dieser Service ist fÃ¼r Diagnose und Modellanalyse gedacht.              â•‘
    â•‘ Die Ergebnisse sind nur fÃ¼r erfahrene Benutzer relevant.                â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ“Š FEATURE IMPORTANCE ANALYSIS - Identifiziert hilfreiche und schÃ¤dliche Features

    Analysiert welche der 20 Input-Features dem TinyLSTM-Modell helfen
    oder schaden, basierend auf Permutation Importance.

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ”¬ WAS MACHT DIESER SERVICE?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    1. Berechnet Baseline-RMSE mit allen Features
    2. FÃ¼r jedes der 20 Features:
       - Mischt die Feature-Werte zufÃ¤llig (Permutation)
       - Berechnet neuen RMSE mit gemischtem Feature
       - Importance = (neuer RMSE - Baseline RMSE)
    3. Kategorisiert Features:
       - ğŸŸ¢ HELPFUL (Importance > +0.01): Feature HILFT der Prognose
       - ğŸ”´ HARMFUL (Importance < -0.01): Feature SCHADET der Prognose
       - âšª NEUTRAL (-0.01 bis +0.01): Feature hat kaum Einfluss

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“‹ ANALYSIERTE FEATURES (20 total)
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    Base Features (17):
    - hour_of_day, day_of_year, season_encoded
    - weather_temp, weather_ghi, weather_wind, weather_humidity
    - weather_rain, weather_clouds, weather_dni, dni_ratio
    - sun_elevation_deg, theoretical_max_kwh, clear_sky_radiation
    - production_yesterday, production_same_hour, elevation_normalized

    Group Features (3 pro Panel-Gruppe):
    - group_azimuth_normalized, group_tilt_normalized, group_capacity_normalized

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“ ERGEBNIS-SPEICHERORT
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    ai_feature_importance database table

    EnthÃ¤lt:
    - feature_importance: Score fÃ¼r jedes Feature
    - helpful_features: Liste der hilfreichen Features
    - harmful_features: Liste der schÃ¤dlichen Features
    - neutral_features: Liste der neutralen Features
    - baseline_rmse: RMSE ohne Permutation
    - analysis_time_seconds: Dauer der Analyse

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âš ï¸ WICHTIGE HINWEISE
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - BenÃ¶tigt ein trainiertes AI-Modell (ai_model_weights database table)
    - BenÃ¶tigt mindestens 10 Validierungs-Samples
    - Rechenintensiv: Kann mehrere Sekunden dauern
    - Ergebnisse dienen nur der ANALYSE - keine automatischen Ã„nderungen!
    - Die Ergebnisse variieren je nach Datenmenge und QualitÃ¤t

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ”§ FÃœR ENTWICKLER
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    Die Ergebnisse kÃ¶nnen genutzt werden um:
    - Features mit negativem Impact zu identifizieren
    - Feature Engineering fÃ¼r zukÃ¼nftige Versionen zu verbessern
    - Zu verstehen welche Wetterdaten am wichtigsten sind
    - Debug-Informationen fÃ¼r Support-Anfragen zu sammeln

    Processing time: ~5-30 Sekunden (abhÃ¤ngig von Sample-Anzahl)

  fields:
    num_permutations:
      name: "Anzahl Permutationen"
      description: >
        Anzahl der Permutationen pro Feature (mehr = stabiler, aber langsamer).
        Standard: 5 (guter Kompromiss zwischen Genauigkeit und Geschwindigkeit)
      required: false
      default: 5
      example: 5
      selector:
        number:
          min: 1
          max: 20
          mode: box

# ============================================================================
# EMERGENCY SERVICES - Manual Day-End Task Execution
# âš ï¸ DEVELOPER ONLY - Nur bei Systemfehlern und auf Anweisung verwenden!
# ============================================================================
# Use these services if automated day-end tasks fail or need manual triggering

run_all_day_end_tasks:
  name: "ğŸŒ™ Run All Day-End Tasks"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•‘ Mehrfache AusfÃ¼hrung kann zu Datenkorruption fÃ¼hren!                    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸŒ™ EMERGENCY SERVICE - Manual execution of complete 23:30 day-end workflow!

    Executes the COMPLETE 10-step sequence that runs automatically at 23:30 daily.

    Task sequence (10 steps - matches production/production_scheduled_tasks.py::end_of_day_workflow):
    1. Finalize Day (read solar_yield_today before midnight reset)
    2. Create Daily Summary (shadow analysis, ML accuracy metrics)
    3. Move to History (archive today's predictions)
    4. Update Yesterday Deviation (yesterday vs forecast comparison)
    5. Calculate Statistics (MAE, RMSE, RÂ² metrics)
    6. Weather Precision (compare forecast vs actual weather)
    7. Update RB Overall Correction (production-based factor)
    8. Night Cleanup (remove duplicates, zero samples)
    9. AI Model Training (TinyLSTM Multi-Output training)
    10. Panel Group Efficiency Learning (per-group efficiency factors)

    What this service does:
    - Saves today's final production data before midnight
    - Analyzes prediction accuracy (hourly + daily)
    - Detects shadow patterns and obstructions
    - Trains AI model with new data (TinyLSTM)
    - Learns panel group efficiency factors
    - Archives predictions to history
    - Cleans up data duplicates
    - Updates correction factors

    Use this service:
    - âš ï¸ If automatic 23:30 task failed
    - Before midnight to manually save today's data
    - To trigger manually if automatic task failed
    - To trigger AI model training manually

    Processing time: ~3-10 seconds (10 steps)

    Database tables affected:
    - daily_summaries database table (new entry for today with shadow analysis)
    - hourly_predictions database table (today moved to history section)
    - ai_seasonal_factors database table (seasonal adjustments updated)
    - coordinator_state database table (yesterday deviation updated)
    - hourly_samples database table (cleaned, duplicates removed)
    - ai_model_weights database table (TinyLSTM model weights)
    - ai_dni_tracker database table (DNI tracking data)

    âš ï¸ CAUTION: Run ONLY ONCE per day to avoid duplicate entries!
    This service calls: coordinator.scheduled_tasks.end_of_day_workflow()
  fields: {}

# ============================================================================
# TESTING SERVICES - Essential Testing and Simulation
# âš ï¸ DEVELOPER ONLY - Nur auf Anweisung verwenden!
# ============================================================================
# These services replicate EXACTLY what happens at specific times.
# âš ï¸ WARNING: Create backup before use - these modify forecast data!
# ============================================================================

test_morning_routine:
  name: "ğŸ§ª TEST: Analyze 6 AM Morning Predictions (Real Data)"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ DEVELOPER ONLY                                                       â•‘
    â•‘ This service is intended for debugging purposes only.                   â•‘
    â•‘ No changes to the system (read-only).                                   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    âš ï¸ ANALYSIS SERVICE - No backup needed (read-only!)

    Analyzes the ACTUAL data that was used at 6:00 AM today.

    Code Reference: services/service_registry.py::_handle_test_morning_routine

    What this service does:
    1. Loads stored predictions from hourly_predictions database table (created at 06:00)
    2. Loads weather data from weather_forecast database table (fetched at 06:00)
    3. Analyzes predicted best hour vs actual best hour
    4. Shows prediction accuracy and errors
    5. Compares ML/Rule blending effectiveness

    This service is READ-ONLY and uses REAL stored data from this morning's
    06:00 routine.

    Use cases:
    - Why was hour X predicted as best?
    - Did the 06:00 routine work correctly?
    - Compare: Predicted vs actual production
    - ML contribution and blending weights

    Data sources:
    - hourly_predictions database table (predictions created at 06:00)
    - weather_forecast database table (weather forecast from Open-Meteo)
  fields: {}

test_retrospective_forecast:
  name: "ğŸ”„ TEST: Retrospective Forecast (Current Code)"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ Erstellt eine "retrospektive" Prognose mit dem AKTUELLEN Code.          â•‘
    â•‘ Schreibt NUR in retrospective_forecast table (beeinflusst keine Daten). â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ”„ RETROSPECTIVE FORECAST - Test code changes without waiting!

    This service creates a forecast for TODAY using the CURRENT code, as if
    it were running at "1 hour before sunrise".

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ¯ WHY USE THIS SERVICE?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    The regular "test_morning_routine" service always creates predictions
    starting from the CURRENT time. This makes it impossible to test code
    changes that were made AFTER the morning forecast.

    Example scenario:
    - 07:00: Automatic morning forecast runs (old code)
    - 14:00: You change a correction factor in the code
    - Problem: Running test_morning_routine at 14:00 only predicts 14:00-sunset

    With THIS service:
    - 14:00: You change a correction factor
    - 14:00: Run test_retrospective_forecast
    - Result: See what the 07:00 forecast WOULD have been with your new code
    - Compare: retrospective_forecast table vs hourly_predictions database table

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“‹ WHAT THIS SERVICE DOES:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    1. Determines today's sunrise time from astronomy cache
    2. Sets simulation time to "sunrise - 1 hour" (e.g., 07:00 in winter)
    3. Loads current weather forecast (weather_forecast database table)
    4. Loads current astronomy data for today
    5. Runs the FULL forecast pipeline with CURRENT code:
       - Physics engine calculations
       - Panel group calculations
       - AI/ML predictions (if available)
       - All correction factors and calibrations
    6. Calculates hourly predictions for ALL production hours (e.g., 08:00-16:00)
    7. Saves result to retrospective_forecast database table

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“ OUTPUT:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    retrospective_forecast database table

    Contains:
    - simulation_context: When/why this was created
    - forecast_summary: Total kWh, best hour, method, confidence
    - hourly_predictions: Detailed per-hour predictions with weather/astronomy
    - weather_data_used: Which weather data was used
    - astronomy_data_used: Sunrise, sunset, daylight hours
    - correction_factor_used: Current correction factor value

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ”’ SAFETY:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - DOES NOT modify hourly_predictions database table
    - DOES NOT affect actual forecasts or sensors
    - ONLY writes to retrospective_forecast database table
    - Safe to run multiple times (overwrites previous result)

    Use cases:
    - Test new correction factors before committing
    - Debug physics engine calculations
    - Compare AI vs Physics predictions
    - Validate panel group calibrations
  fields: {}

# ============================================================================
# ASTRONOMY SERVICES - Independent Solar Calculations
# âš ï¸ DEVELOPER ONLY - Kann berechnete Astronomie-Daten Ã¼berschreiben!
# ============================================================================
# These services manage the astronomy cache which provides sun positions,
# solar radiation, and production windows independent of sun.sun entity.
# ============================================================================

build_astronomy_cache:
  name: "ğŸŒ Build Astronomy Cache"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•‘ Ãœberschreibt existierende Astronomie-Daten!                             â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸŒ ASTRONOMY SERVICE - Build comprehensive solar position and radiation cache!

    Creates physics-based astronomical data cache for ML feature engineering and production validation.

    What this service does:
    - Calculates sun position (elevation, azimuth) for every hour (0-23)
    - Computes clear-sky solar radiation using atmospheric physics model
    - Calculates theoretical maximum PV output based on YOUR system capacity
    - Determines production windows (sunrise -30min to sunset +30min)
    - Generates solar noon, daylight hours, day progress ratios

    âš ï¸ IMPORTANT: Uses your configured solar_capacity!
    All theoretical_max_pv values will be calculated for YOUR specific system size.

    The cache is used for:
    - ML feature engineering (3 astronomy features: sun_elevation, theoretical_max, clear_sky_radiation)
    - Physics-based prediction bounds (prevents unrealistic forecasts)
    - Shadow detection (compares actual lux vs clear-sky radiation)
    - Production window validation (replaces sun.sun entity dependency)

    Default settings:
    - days_back: 30 days (historical analysis + geometry learning)
    - days_ahead: 7 days (forecast planning)
    - system_capacity_kwp: FROM YOUR INTEGRATION CONFIG (e.g., 2.13 kWp)

    Use this service:
    - âœ… After updating solar_capacity in integration settings (rebuilds with correct kWp!)
    - On first setup (runs automatically during installation)
    - After changing Home Assistant location
    - To rebuild corrupted cache data
    - To extend historical range for analysis

    Processing time: ~5 seconds for 37 days (30 back + today + 7 ahead)
    Storage: astronomy_cache database table (~250 KB equivalent with hourly granularity)

    Database: /config/solar_forecast_ml/data/solar_forecast.db

    Location data: Automatically from Home Assistant configuration
    - Latitude, Longitude, Elevation, Timezone

    âš ï¸ CAUTION: I/O intensive - avoid running during active ML training!
  fields:
    days_back:
      description: "Days to calculate backwards from today (default: 30)"
      example: 30
      default: 30
      selector:
        number:
          min: 1
          max: 730
          mode: box
    days_ahead:
      description: "Days to calculate ahead from today (default: 7)"
      example: 7
      default: 7
      selector:
        number:
          min: 1
          max: 30
          mode: box

refresh_cache_today:
  name: "ğŸ”„ Refresh Cache for Today"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Refresh astronomy cache for today + next 7 days.

    This service updates the astronomy cache with fresh calculations
    for the current week. It's designed for daily maintenance.

    What this does:
    - Recalculates: Today + next 7 days
    - Updates: Sun positions, solar radiation, production windows
    - Preserves: Historical data (not recalculated)
    - Maintains: Max peak records (not overwritten)

    When this runs:
    - Automatically at 6:00 AM daily (planned)
    - Manually via this service call
    - After Home Assistant restart

    Why daily refresh:
    - Ensures accurate production windows for today
    - Updates forecast data for next week
    - Accounts for seasonal changes (sunrise/sunset shifts)
    - Maintains cache freshness

    Processing time: ~1 second (only 8 days recalculated)

    Use this service:
    - To manually refresh current week data
    - If automatic 6 AM task failed
    - After system capacity changes
    - To test cache refresh logic

    NOTE: This service does NOT rebuild historical data.
    Use build_astronomy_cache for full rebuilds.
  fields: {}

# ============================================================================
# WEATHER SERVICES - Weather Data Management
# âš ï¸ DEVELOPER ONLY - Kann Wetterdaten und Caches Ã¼berschreiben!
# ============================================================================

run_weather_correction:
  name: "ğŸ”„ Rebuild Corrected Weather Forecast"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•‘ Ãœberschreibt existierende Wettervorhersage-Korrekturen!                 â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    âš ï¸ MANUAL TRIGGER - Rebuilds weather_forecast database table immediately!

    This service manually triggers the corrected weather forecast generation
    which normally runs automatically at:
    - 00:15 LOCAL: Before first morning forecast (00:25)
    - sunrise-40min: Before final morning forecast (sunrise-30min)

    What this does:
    1. Loads raw weather forecast from weather_forecast database table
    2. Loads precision correction factors from weather_precision_daily database table
    3. Loads astronomy data for clear_sky calculations
    4. Applies physics-based corrections (clear_sky Ã— cloud_factor)
    5. Saves corrected forecast to weather_forecast database table

    Use this service:
    - To test weather correction logic immediately
    - If automatic tasks failed
    - After manually refreshing weather data

    Processing time: ~1 second

    Result: weather_forecast database table (corrected forecast)

    IMPORTANT: This service will overwrite the existing corrected forecast!
  fields: {}

refresh_open_meteo_cache:
  name: "Refresh Open-Meteo Direct Radiation Cache"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ âš ï¸ NUR FÃœR ENTWICKLER / DEVELOPER ONLY                                  â•‘
    â•‘ FÃ¼hren Sie diesen Service NUR auf Anweisung des Supports aus!           â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Manually refresh Open-Meteo direct radiation data!

    This service fetches fresh radiation forecasts from Open-Meteo API
    and updates the persistent cache (weather_forecast database table).

    What this does:
    1. Fetches 72-hour forecast from api.open-meteo.com
    2. Gets direct_radiation, diffuse_radiation, GHI (W/m2)
    3. Gets temperature, clouds, humidity, wind, precipitation
    4. Updates in-memory cache for immediate use
    5. Saves to weather_forecast database table (survives HA restarts)

    Direct Radiation Mode:
    - Uses GHI (Global Horizontal Irradiance) directly from API
    - No cloud-to-radiation calculation needed
    - More accurate than physics-based cloud models
    - GHI = direct_radiation + diffuse_radiation

    Automatic schedule:
    - 00:10 LOCAL: Pre-midnight refresh (before 00:15 corrected forecast)
    - sunrise-45min: Dynamic refresh (before final morning forecast)

    Use this service when:
    - After HA restart if cache is stale (>12 hours old)
    - "Open-Meteo unavailable" warnings in logs
    - Want immediate weather/radiation data refresh

    Processing time: ~2-5 seconds (depends on API response)

    Result:
    - weather_forecast database table (persistent)
    - In-memory cache (immediate use in corrected forecast)

    API: api.open-meteo.com (free, no API key required)
  fields: {}

refresh_multi_weather:
  name: "ğŸŒ¤ï¸ Refresh Multi-Weather Cache"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ â„¹ï¸ SICHER / SAFE - Kann von Benutzern verwendet werden                   â•‘
    â•‘ Dieser Service aktualisiert nur Wetter-Caches.                          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸŒ¤ï¸ Refresh Multi-Weather blended forecast (Open-Meteo + wttr.in)!

    This service fetches weather data from multiple sources and blends
    cloud cover predictions using learned accuracy weights.

    What this does:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    1. Fetches 72-hour forecast from Open-Meteo (primary source)
    2. If cloud_cover > 50%: Also fetches from wttr.in (World Weather Online)
    3. Blends cloud_cover using learned weights (based on past accuracy)
    4. Saves blended forecast to weather_forecast database table
    5. Updates wttr_in_cache database table (6h cache, 12h fallback)

    Multi-Source Blending:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - Open-Meteo predicted 100% clouds, wttr.in predicted 35%
    - With learned weights (30% OM, 70% WWO): Blended = 54%
    - Actual was 10% â†’ wttr.in was more accurate â†’ Gets higher weight next time

    Cache Strategy:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - wttr.in cache: 6 hours (normal), 12 hours (fallback if API down)
    - Reduces API calls (wttr.in has ~100 req/hour limit)
    - Automatic retry with stale cache if API timeout

    Automatic schedule:
    - 06:00, 12:00, 18:00: Multi-Weather update (with trigger check)
    - 23:30: Weight learning from daily actual data

    Use this service when:
    - Want immediate Multi-Weather refresh
    - After configuration changes
    - To test blending logic

    Processing time: ~3-10 seconds (depends on API responses)

    Result:
    - weather_forecast database table (blended forecast)
    - wttr_in_cache database table (wttr.in cache)
    - weather_source_weights database table (learned weights)
  fields:
    force_update:
      name: "Force Update"
      description: >
        V16: Force a fresh API call to ALL weather sources (Open-Meteo, wttr.in,
        Bright Sky, Pirate Weather) even if the cache is still valid.
        This bypasses the memory cache and forces new API requests.
        Use this to get fresh visibility data for fog detection.
        Default: false (uses cache if still valid)
      required: false
      default: false
      example: true
      selector:
        boolean:

send_daily_briefing:
  name: Send Daily Solar Briefing
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ â„¹ï¸ SICHER / SAFE - Kann von Benutzern verwendet werden                   â•‘
    â•‘ Dieser Service sendet nur Benachrichtigungen und Ã¤ndert keine Daten.    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â˜€ï¸ Send a daily solar weather briefing notification with today's forecast.

    This service generates and sends a formatted notification with:
    - Today's solar forecast (kWh prediction)
    - Weather interpretation (sunny, partly cloudy, etc.)
    - Comparison to yesterday's actual production
    - Best production time (Solar Noon)
    - Sunrise/Sunset times and daylight duration
    - Smart emoji indicators

    Perfect for morning routines to know what to expect from your solar system!

    Example notification:
    Title: "â˜€ï¸ Solar Forecast - Samstag, 16. Nov"
    Message:
    "ğŸŒ Guter Solar-Tag erwartet!

    ğŸ“Š Forecast: 4.45 kWh
       â†’ 6x besser als gestern (0.7 kWh)

    ğŸŒ¤ï¸ Wetter: Sonnig bis teilweise bewÃ¶lkt
       Beste Zeit: 10:51 Uhr (Solar Noon)

    â° Tageslicht: 8h 35min
       ğŸŒ… Aufgang: 06:34 Uhr
       ğŸŒ‡ Untergang: 15:11 Uhr

    Viel Sonne heute! â˜€ï¸"

    Use this service:
    - In automations for daily morning notifications
    - Manually to check today's forecast briefing
    - With different notify services (mobile_app, persistent_notification, etc.)

    Tip: Create an automation that runs at 07:00 every morning!
  fields:
    notify_service:
      name: Mobile Device (Optional)
      description: >
        OPTIONAL: Add your mobile device to receive an additional push notification.

        - Leave EMPTY or use "persistent_notification": Full message in HA UI only (recommended for most users)
        - Enter "mobile_app_iphone" (or your device name): Get BOTH push notification + HA UI message

        The full briefing is ALWAYS shown in Home Assistant UI (notification bell icon).

        To find your device name: Go to Developer Tools > Services and search for "notify.mobile_app"
      example: "mobile_app_iphone"
      default: "persistent_notification"
      required: false
      selector:
        text:
    language:
      name: Language
      description: Language for the notification text (de=German, en=English)
      example: "de"
      default: "de"
      required: false
      selector:
        select:
          options:
            - label: "Deutsch"
              value: "de"
            - label: "English"
              value: "en"

# ============================================================================
# DATA MANAGEMENT SERVICES - Reset and Cleanup
# âš ï¸ USER CONTROLLED - Setzt gelernte Daten zurÃ¼ck (mit Backup)
# ============================================================================

borg_assimilation_reverse:
  name: "ğŸ–– Borg Assimilation Reverse"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ ğŸ–– BENUTZER-SERVICE / USER SERVICE                                       â•‘
    â•‘ Setzt gelernte Daten zurÃ¼ck - IMMER mit automatischem Backup!            â•‘
    â•‘ "We are the Borg. Your data distinctiveness will be... restored."        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ–– BORG ASSIMILATION REVERSE - Entfernt "assimilierte" (gelernte) Daten!

    Dieser Service setzt ausgewÃ¤hlte gelernte Daten auf neutrale Standardwerte
    zurÃ¼ck. Ein automatisches Backup wird VOR dem Reset erstellt.

    Wann verwenden?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âœ… Falsche Sensoren waren konfiguriert und wurden korrigiert
    âœ… Panel-Gruppen wurden nachtrÃ¤glich hinzugefÃ¼gt/geÃ¤ndert
    âœ… ML-Modell produziert konsistent schlechte Vorhersagen
    âœ… "Garbage Data" aus der Anfangszeit entfernen
    âœ… Nach grÃ¶ÃŸeren KonfigurationsÃ¤nderungen (solar_capacity, Standort)

    VerfÃ¼gbare Targets:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ§  ai_weights
       Setzt AI-Daten zurÃ¼ck:
       - ai_model_weights database table (TinyLSTM weights)
       - ai_seasonal_factors database table (seasonal factors)
       - ai_dni_tracker database table (DNI tracking)
       âœ ML-Modell startet Training von Grund auf neu

    ğŸ“œ hourly_history
       Entfernt alte EintrÃ¤ge:
       - hourly_predictions database table
       - hourly_weather_actual database table
       - Optional: before_date Parameter fÃ¼r gezieltes LÃ¶schen
       âœ Entfernt "Garbage Data" aus der Vergangenheit

    ğŸ”„ all
       FÃ¼hrt ALLE obigen Resets durch
       âœ Kompletter Neustart des Lernsystems

    Sicherheit:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âœ“ Automatisches Backup in: /solar_forecast_ml/backups/borg_reverse_YYYYMMDD_HHMMSS/
    âœ“ Backup enthÃ¤lt alle betroffenen Daten vor dem Reset
    âœ“ Backup-Retention: 30 Tage (Ã¤ltere werden automatisch gelÃ¶scht)

    Nach dem Reset:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - System startet sofort mit neutralen Werten
    - Lernen beginnt automatisch beim nÃ¤chsten Daten-Eingang
    - ML-Modell: Training lÃ¤uft um 06:00 tÃ¤glich

    Beispiele:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Nur AI-Gewichte zurÃ¼cksetzen
    service: solar_forecast_ml.borg_assimilation_reverse
    data:
      target: ai_weights

    # Alles zurÃ¼cksetzen + Garbage vor dem 15.12. entfernen
    service: solar_forecast_ml.borg_assimilation_reverse
    data:
      target: all
      before_date: "2025-12-15"

  fields:
    target:
      name: "Reset-Ziel"
      description: >
        Was soll zurÃ¼ckgesetzt werden?
        - ai_weights: AI/ML-Modell Gewichte (learned_weights, seasonal, dni_tracker)
        - hourly_history: StÃ¼ndliche Vorhersage-Historie
        - all: Alles oben genannte
      required: true
      example: "ai_weights"
      selector:
        select:
          options:
            - label: "ğŸ§  AI-Modell Gewichte"
              value: "ai_weights"
            - label: "ğŸ“œ StÃ¼ndliche Historie"
              value: "hourly_history"
            - label: "ğŸ”„ Alles"
              value: "all"
    before_date:
      name: "Daten VOR diesem Datum lÃ¶schen (optional)"
      description: >
        Optional: Nur fÃ¼r target=hourly_history oder target=all.
        LÃ¶scht nur EintrÃ¤ge VOR diesem Datum.
        Format: YYYY-MM-DD (z.B. 2025-12-15)
        Wenn nicht angegeben: LÃ¶scht EintrÃ¤ge Ã¤lter als 30 Tage.
      required: false
      example: "2025-12-15"
      selector:
        date:
    keep_backup:
      name: "Backup erstellen"
      description: >
        Erstellt automatisch ein Backup vor dem Reset.
        DRINGEND EMPFOHLEN! Standard: true
      required: false
      default: true
      selector:
        boolean:

# ============================================================================
# INSTALLATION SERVICES - Extra Features Management
# ============================================================================

# ============================================================================
# PHYSICS CALIBRATION SERVICES - Emergency Calibration
# ğŸš¨ DEVELOPER ONLY - NUR AUF ANWEISUNG DES ENTWICKLERS AUSFÃœHREN!
# ============================================================================

rescue_calibration:
  name: "ğŸš¨ Rescue Calibration (DEVELOPER ONLY)"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ ğŸš¨ğŸš¨ğŸš¨ WARNUNG / WARNING ğŸš¨ğŸš¨ğŸš¨                                          â•‘
    â•‘                                                                          â•‘
    â•‘ NUR AUF ANWEISUNG DES ENTWICKLERS AUSFÃœHREN!                            â•‘
    â•‘ DO NOT RUN WITHOUT EXPLICIT DEVELOPER INSTRUCTION!                       â•‘
    â•‘                                                                          â•‘
    â•‘ Dieser Service ist NUR fÃ¼r Systeme gedacht, bei denen die normale       â•‘
    â•‘ Kalibrierung aufgrund extremer Abweichungen nicht funktioniert.         â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸš¨ RESCUE CALIBRATION - Einmalige Notfall-Kalibrierung fÃ¼r stark unterkalibrierte Systeme

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ¯ WANN WIRD DIESER SERVICE BENÃ–TIGT?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    Dieser Service lÃ¶st das "Henne-Ei-Problem":
    - Die Physics Engine berechnet z.B. 0.66 kWh Vorhersage
    - TatsÃ¤chliche Produktion war aber 7.09 kWh (Faktor ~11x)
    - Normale Kalibrierung Ã¼berspringt Ratios > 10 als "Outlier"
    - Das System kann sich nie selbst korrigieren!

    âš ï¸ GÃœLTIGER BEREICH: Ratio 10-40, NUR letzte 5 Tage
    - Ratio < 10: Normale Kalibrierung funktioniert â†’ Service nicht nÃ¶tig
    - Ratio 10-40: Rescue Calibration mÃ¶glich â†’ Service fÃ¼hrt Kalibrierung durch
    - Ratio > 40: Wahrscheinlich Konfigurationsfehler â†’ Service bricht ab mit Warnung

    â±ï¸ ZEITFENSTER: Nur Daten der letzten 5 Tage
    - Verhindert Einbeziehung alter, falscher Daten nach Sensorkorrekturen
    - Nach Neukonfiguration: 2 Tage warten, dann Service ausfÃ¼hren

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ”§ WAS MACHT DIESER SERVICE?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    1. Analysiert daily_summaries und physics_calibration_history database tables
    2. Sucht nach mindestens 2 Tagen mit Ratio zwischen 10 und 40 (actual/physics)
    3. PrÃ¼ft ob Ratio > 40 â†’ Wahrscheinlich Konfigurationsfehler â†’ BRICHT AB
    4. Falls 10-40: FÃ¼hrt EINMALIGE Kalibrierung mit erhÃ¶htem MAX_FACTOR=50 durch
    5. Setzt Korrektur-Faktoren auf MAX_CORRECTION_FACTOR=10 (fÃ¼r normalen Betrieb)
    6. Das System lernt ab dann normal weiter

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âš ï¸ VORAUSSETZUNGEN
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - Mindestens 2 Tage mit Abweichung im gÃ¼ltigen Bereich (Ratio 10-40) mÃ¼ssen vorhanden sein
    - Nur Daten der LETZTEN 5 TAGE werden berÃ¼cksichtigt (Zeitfenster-Schutz)
    - Die Daten mÃ¼ssen in hourly_predictions oder daily_summaries database tables existieren
    - Der Service wird NICHT ausgefÃ¼hrt, wenn weniger als 2 Tage gefunden werden
    - Der Service BRICHT AB bei Ratio > 40 (Konfigurationsfehler wahrscheinlich)

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“ BETROFFENE DATEN
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - physics_learning_config database table (wird aktualisiert)
    - Liest: daily_summaries, hourly_predictions, physics_calibration_history database tables

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    â„¹ï¸ NACH DER AUSFÃœHRUNG
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - Das System verwendet sofort die neuen Korrektur-Faktoren
    - Normale tÃ¤gliche Kalibrierung (23:30) arbeitet wieder normal
    - Der Service muss NICHT erneut ausgefÃ¼hrt werden
    - Wenn das Problem bestehen bleibt, kontaktieren Sie den Support

  fields: {}

repair_calibration:
  name: "ğŸ”§ Repair Calibration Factors (DEVELOPER ONLY)"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ ğŸš¨ğŸš¨ğŸš¨ WARNUNG / WARNING ğŸš¨ğŸš¨ğŸš¨                                          â•‘
    â•‘                                                                          â•‘
    â•‘ NUR AUF ANWEISUNG DES ENTWICKLERS AUSFÃœHREN!                            â•‘
    â•‘ DO NOT RUN WITHOUT EXPLICIT DEVELOPER INSTRUCTION!                       â•‘
    â•‘                                                                          â•‘
    â•‘ Dieser Service analysiert und repariert extreme Kalibrierungsfaktoren.  â•‘
    â•‘ Falsche Anwendung kann zu dauerhaft schlechten Prognosen fÃ¼hren!        â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ”§ REPAIR CALIBRATION - Analysiert und korrigiert extreme Bucket-Faktoren

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ¯ WANN WIRD DIESER SERVICE BENÃ–TIGT?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    Wenn der PhysicsCalibrator aus kontaminierten Daten (z.B. Snow/Frost-Samples)
    extreme Korrekturfaktoren gelernt hat, die zu Ãœber- oder UnterschÃ¤tzungen fÃ¼hren.

    Symptome:
    - Bucket-Faktor > 4 (z.B. fair_low_sun = 6.3 statt realistisch 2-4)
    - Konsistente ÃœberschÃ¤tzung der Prognose
    - Faktoren die > 2Ã— dem globalen Faktor entsprechen

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ”§ WAS MACHT DIESER SERVICE?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    1. LÃ¤dt physics_learning_config database table und analysiert alle Bucket-Faktoren
    2. Identifiziert AusreiÃŸer basierend auf konfigurierbaren Schwellwerten:
       - Faktoren > max_allowed_factor (Standard: 4.0)
       - Faktoren > global_factor Ã— max_global_ratio (Standard: 2.0)
    3. Erstellt detaillierten Bericht aller gefundenen Probleme
    4. Optional: Korrigiert Faktoren auf target_factor (Standard: 3.0)
    5. IMMER: Erstellt Backup vor Ã„nderungen

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“Š MODI
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    dry_run: true (Standard)
      - Nur Analyse, keine Ã„nderungen
      - Zeigt was korrigiert WÃœRDE
      - Sicher zum Ausprobieren

    dry_run: false
      - Erstellt Backup
      - Korrigiert alle AusreiÃŸer auf target_factor
      - Speichert geÃ¤nderte physics_learning_config database table

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“ BETROFFENE DATEN
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    Liest:  physics_learning_config database table
    Backup: /config/solar_forecast_ml/backups/repair_calibration/backup_YYYYMMDD_HHMMSS/
    Ã„ndert: physics_learning_config database table (nur wenn dry_run=false)

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âš ï¸ WICHTIGE HINWEISE
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - Manche Systeme haben LEGITIME hohe Faktoren (Verschattung, besondere Ausrichtung)
    - PrÃ¼fen Sie den Bericht genau bevor Sie dry_run=false setzen
    - Nach Korrektur: Home Assistant neustarten!
    - Das System lernt weiter - Faktoren werden sich wieder anpassen

  fields:
    max_allowed_factor:
      name: "Maximaler erlaubter Faktor"
      description: >
        Faktoren Ã¼ber diesem Wert werden als AusreiÃŸer markiert.
        Standard: 4.0 (realistische Faktoren liegen meist bei 1.5-3.5)
      required: false
      default: 4.0
      example: 4.0
      selector:
        number:
          min: 2.0
          max: 10.0
          step: 0.5
          mode: box
    max_global_ratio:
      name: "Max. VerhÃ¤ltnis zum Global-Faktor"
      description: >
        Bucket-Faktoren die mehr als X-mal so hoch wie der globale Faktor
        der Gruppe sind, werden als AusreiÃŸer markiert.
        Standard: 2.0 (z.B. global=2.0 â†’ max erlaubt=4.0)
      required: false
      default: 2.0
      example: 2.0
      selector:
        number:
          min: 1.5
          max: 5.0
          step: 0.5
          mode: box
    target_factor:
      name: "Ziel-Faktor fÃ¼r Korrekturen"
      description: >
        AusreiÃŸer werden auf diesen Wert korrigiert.
        Standard: 3.0 (konservativer Mittelwert)
      required: false
      default: 3.0
      example: 3.0
      selector:
        number:
          min: 1.0
          max: 5.0
          step: 0.5
          mode: box
    dry_run:
      name: "Nur Analyse (dry_run)"
      description: >
        true = Nur analysieren, nichts Ã¤ndern (EMPFOHLEN fÃ¼r ersten Durchlauf)
        false = Backup erstellen und Faktoren korrigieren
      required: false
      default: true
      example: true
      selector:
        boolean:

winter_bucket_correction_v16:
  name: "ğŸŒ¨ï¸ Winter Bucket Correction V16 (DEVELOPER ONLY)"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ ğŸš¨ğŸš¨ğŸš¨ WARNUNG / WARNING ğŸš¨ğŸš¨ğŸš¨                                          â•‘
    â•‘                                                                          â•‘
    â•‘ NUR AUF ANWEISUNG DES ENTWICKLERS AUSFÃœHREN!                            â•‘
    â•‘ DO NOT RUN WITHOUT EXPLICIT DEVELOPER INSTRUCTION!                       â•‘
    â•‘                                                                          â•‘
    â•‘ Falsche Anwendung kann die KI-Kalibrierung nachhaltig schÃ¤digen und     â•‘
    â•‘ zu dauerhaft schlechten Prognosen fÃ¼hren!                               â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸŒ¨ï¸ WINTER BUCKET CORRECTION V16 - Korrigiert Bucket-Konfidenz fÃ¼r V16

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ¯ HINTERGRUND
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    V16 fÃ¼hrt eine neue, physikalisch korrektere Cloud-Faktor-Berechnung ein.
    Die alten Bucket-Faktoren wurden mit der falschen (zu optimistischen) Formel
    kalibriert. Dieser Service reduziert die KONFIDENZ (nicht die Faktor-Werte!),
    damit das System schneller mit der neuen Formel neu lernen kann.

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ”§ WAS MACHT DIESER SERVICE?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    1. LÃ¤dt physics_learning_config database table
    2. Reduziert die `confidence` aller Bucket-Faktoren auf den angegebenen Wert
    3. BEHÃ„LT die Faktor-WERTE bei (keine LÃ¶schung der Kalibrierung!)
    4. Erstellt IMMER ein Backup vor der Ã„nderung
    5. Das System lernt dann schneller mit neuen Daten

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“Š BEISPIEL
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    VOR dem Reset:
    - fair_low_sun: factor=2.5, confidence=0.95, samples=150

    NACH dem Reset (target_confidence=0.5):
    - fair_low_sun: factor=2.5, confidence=0.50, samples=150

    â†’ Der Faktor 2.5 bleibt erhalten als Startpunkt
    â†’ Die niedrigere Konfidenz erlaubt schnellere Anpassung
    â†’ Neue Samples haben mehr Gewicht beim Lernen

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âš ï¸ RISIKEN BEI FALSCHER ANWENDUNG
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - Bestehende, gut funktionierende Kalibrierung wird geschwÃ¤cht
    - System braucht mehrere Tage um sich neu zu kalibrieren
    - Bei neuen Installationen kann es die Lernphase verlÃ¤ngern
    - Mehrfache Anwendung kann zu instabilen Prognosen fÃ¼hren

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âœ… WANN IST DIESER SERVICE SINNVOLL?
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    NUR nach RÃ¼cksprache mit dem Entwickler, wenn:
    - Das System bereits lÃ¤nger mit Ã¤lteren Versionen kalibriert war
    - Die Winter-Prognosen stark daneben lagen (>50% Abweichung)
    - Der Entwickler dies explizit empfohlen hat

    âŒ NICHT verwenden bei:
    - Neuen Installationen (< 14 Tage alt)
    - Bereits gut funktionierenden Prognosen
    - Ohne RÃ¼cksprache mit dem Entwickler

  fields:
    target_confidence:
      name: "Ziel-Konfidenz"
      description: >
        Alle Bucket-Konfidenzen werden auf diesen Wert gesetzt.
        - 0.5 (Standard): Erlaubt moderate Anpassung, behÃ¤lt bisherige Richtung
        - 0.3: Aggressivere Anpassung, schnelleres Neulernen
        - 0.7: Konservativ, weniger Ã„nderung
        âš ï¸ Niedrigere Werte = aggressiveres Neulernen = hÃ¶heres Risiko!
      required: false
      default: 0.5
      example: 0.5
      selector:
        number:
          min: 0.1
          max: 0.9
          step: 0.1
          mode: slider
    dry_run:
      name: "Nur Analyse (dry_run)"
      description: >
        true = Nur analysieren, zeigt was geÃ¤ndert wÃ¼rde (EMPFOHLEN!)
        false = Backup erstellen und Konfidenzen zurÃ¼cksetzen
        âš ï¸ IMMER zuerst mit dry_run=true testen!
      required: false
      default: true
      example: true
      selector:
        boolean:

install_extra_features:
  name: "ğŸ“¦ Install Extra Features"
  description: >
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘ â„¹ï¸ SICHER / SAFE - Kann von Benutzern verwendet werden                   â•‘
    â•‘ Dieser Service installiert zusÃ¤tzliche Integrationen.                   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ“¦ Install extra feature integrations to your custom_components folder!

    This service copies additional integrations from the extra_features folder
    to your custom_components directory, making them available for configuration.

    Available features:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“Š grid_price_monitor
       - Dynamic grid electricity price monitoring
       - Tibber/Awattar/EPEX Spot integration
       - Price-based automation triggers

    ğŸ“ˆ sfml_stats
       - Solar Forecast ML Statistics Dashboard
       - Detailed accuracy metrics and charts
       - Historical performance analysis

    What this service does:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    1. Checks which features are available in extra_features/
    2. Copies each feature to custom_components/
    3. Creates a persistent notification with instructions
    4. Reports success/failure for each feature

    After installation:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    âš ï¸ RESTART HOME ASSISTANT to load the new integrations!

    Then configure via:
    Settings â†’ Devices & Services â†’ Add Integration â†’ Search for feature name

    Processing time: ~1-2 seconds

    Use this service:
    - After fresh Solar Forecast ML installation
    - To update extra features to latest version
    - When new extra features become available
  fields: {}

backfill_shadow_detection:
  name: "ğŸ” Backfill Shadow Detection"
  description: >
    Runs shadow detection for hours that have actual production data but no shadow detection results.

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ“Š WHAT IT DOES:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    1. Finds all hours with actual_kwh but no shadow_detection
    2. Loads astronomy and weather data for each hour
    3. Runs ensemble shadow detection
    4. Saves results to hourly_shadow_detection table
    5. Refreshes coordinator cache

    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸ¯ USE CASES:
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    - After fixing shadow detection bugs
    - To fill gaps in shadow detection data
    - For debugging shadow detection issues
    - Before running Shadow Pattern Learning (EOD Step 12)

    Processing time: ~1-5 seconds depending on number of hours
  fields:
    target_date:
      name: "Target Date"
      description: "Date to backfill shadow detection for (YYYY-MM-DD). Leave empty for today."
      required: false
      example: "2026-02-04"
      selector:
        text:
